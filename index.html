<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="theme-color" content="#c8922a"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Nakshatram"/>
<title>Nakshatram â€” Kerala Panchang</title>
<link rel="manifest" href="manifest.json"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Noto+Sans+Malayalam:wght@400;600&family=Cinzel:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:        #0e0600;
  --bg2:       #1a0d03;
  --bg3:       #251507;
  --card:      #1f1005;
  --border:    #5a3010;
  --gold:      #c8922a;
  --gold2:     #e8b84b;
  --gold3:     #f7d98a;
  --teal:      #1e7b6e;
  --teal2:     #27a898;
  --crimson:   #8b1a2f;
  --crimson2:  #c42a45;
  --text:      #f0dbb5;
  --text2:     #b8946a;
  --text3:     #7a5c38;
  --star:      #f7d98a;
  --moon:      #e8c87a;
  --radius:    16px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { height: 100%; }

body {
  min-height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'Cormorant Garamond', Georgia, serif;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€ BACKGROUND PATTERN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background-image:
    radial-gradient(ellipse 60% 40% at 20% 10%, rgba(200,146,42,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 50% 60% at 80% 90%, rgba(30,123,110,0.07) 0%, transparent 60%),
    url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c8922a' fill-opacity='0.03'%3E%3Cpath d='M30 0l3.09 9.51H43.5l-8.31 6.04 3.17 9.76L30 19.4l-8.36 5.91 3.17-9.76L16.5 9.51H26.91z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  pointer-events: none;
}

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; min-height: 100svh; display: flex; flex-direction: column; }

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  padding: 20px 20px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.header-ornament {
  display: flex; align-items: center; gap: 10px;
  width: 100%;
  justify-content: center;
}

.header-ornament::before,
.header-ornament::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
}

.moon-icon {
  font-size: 28px;
  filter: drop-shadow(0 0 12px rgba(232,184,75,0.6));
  animation: moonPulse 4s ease-in-out infinite;
}
@keyframes moonPulse {
  0%,100% { filter: drop-shadow(0 0 8px rgba(232,184,75,0.5)); }
  50% { filter: drop-shadow(0 0 20px rgba(232,184,75,0.9)); }
}

h1 {
  font-family: 'Cinzel', serif;
  font-size: 26px;
  font-weight: 600;
  letter-spacing: 0.12em;
  color: var(--gold2);
  text-align: center;
}

.subtitle {
  font-family: 'Noto Sans Malayalam', sans-serif;
  font-size: 13px;
  color: var(--text3);
  letter-spacing: 0.05em;
  text-align: center;
  margin-bottom: 8px;
}

/* â”€â”€â”€ TODAY CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.today-card {
  margin: 16px 16px 0;
  background: linear-gradient(135deg, var(--bg3) 0%, var(--card) 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  position: relative;
  overflow: hidden;
}

.today-card::before {
  content: '';
  position: absolute;
  top: -30px; right: -30px;
  width: 120px; height: 120px;
  background: radial-gradient(circle, rgba(200,146,42,0.12), transparent 70%);
  pointer-events: none;
}

.today-label {
  font-size: 11px;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 6px;
  font-family: 'Cinzel', serif;
}

.today-date-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.today-ml-date {
  font-size: 22px;
  font-weight: 600;
  color: var(--gold2);
  line-height: 1.1;
}

.today-ml-year {
  font-size: 13px;
  color: var(--text2);
  margin-top: 2px;
}

.today-nakshatra-badge {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.nakshatra-tag {
  background: linear-gradient(135deg, var(--teal), var(--teal2));
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.04em;
  box-shadow: 0 2px 12px rgba(30,123,110,0.4);
}

.nakshatra-ml {
  font-family: 'Noto Sans Malayalam', sans-serif;
  font-size: 11px;
  color: var(--text3);
  margin-top: 3px;
}

.panchang-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 14px;
}

.p-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(90,48,16,0.5);
  border-radius: 10px;
  padding: 8px 10px;
}

.p-item-label {
  font-size: 10px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 3px;
}

.p-item-value {
  font-size: 14px;
  color: var(--text);
  font-weight: 600;
}

/* â”€â”€â”€ SECTION TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title {
  font-family: 'Cinzel', serif;
  font-size: 12px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text3);
  padding: 20px 20px 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, var(--border), transparent);
}

/* â”€â”€â”€ NAKSHATRA SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nakshatra-selector {
  padding: 0 16px;
}

.selector-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.selector-header {
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s;
}
.selector-header:hover { background: rgba(200,146,42,0.05); }

.selector-icon { font-size: 22px; }

.selector-info { flex: 1; }

.selector-name {
  font-size: 18px;
  font-weight: 600;
  color: var(--gold2);
}

.selector-detail {
  font-size: 12px;
  color: var(--text3);
  margin-top: 2px;
  font-family: 'Noto Sans Malayalam', sans-serif;
}

.selector-chevron {
  color: var(--text3);
  font-size: 18px;
  transition: transform 0.3s;
}

.selector-chevron.open { transform: rotate(180deg); }

/* NAKSHATRA GRID */
.nakshatra-grid {
  display: none;
  grid-template-columns: repeat(3, 1fr);
  gap: 1px;
  background: var(--border);
  border-top: 1px solid var(--border);
  max-height: 340px;
  overflow-y: auto;
}
.nakshatra-grid.open { display: grid; }

.nakshatra-cell {
  background: var(--card);
  padding: 10px 8px;
  cursor: pointer;
  text-align: center;
  transition: background 0.15s;
}
.nakshatra-cell:hover { background: rgba(200,146,42,0.08); }
.nakshatra-cell.selected { background: rgba(200,146,42,0.15); }

.nakshatra-cell .n-num {
  font-size: 10px;
  color: var(--text3);
  font-family: 'Cinzel', serif;
}
.nakshatra-cell .n-name {
  font-size: 13px;
  color: var(--text);
  font-weight: 600;
  line-height: 1.2;
  margin-top: 2px;
}
.nakshatra-cell .n-ml {
  font-family: 'Noto Sans Malayalam', sans-serif;
  font-size: 11px;
  color: var(--text3);
  margin-top: 1px;
}
.nakshatra-cell.selected .n-name { color: var(--gold2); }

/* â”€â”€â”€ UPCOMING EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.events-list { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }

.event-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 14px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, transform 0.15s;
  cursor: pointer;
}
.event-card:hover { border-color: var(--gold); transform: translateX(2px); }
.event-card:active { transform: scale(0.99); }

.event-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
}
.event-card.type-janma::before { background: var(--gold2); }
.event-card.type-festival::before { background: var(--crimson2); }
.event-card.type-vavu::before { background: var(--teal2); }
.event-card.type-monthly::before { background: #7a5cb8; }

.event-date-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 44px;
  text-align: center;
}

.event-day-num {
  font-size: 26px;
  font-weight: 700;
  line-height: 1;
  color: var(--gold2);
  font-family: 'Cinzel', serif;
}

.event-month-abbr {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text3);
  margin-top: 2px;
}

.event-divider {
  width: 1px;
  height: 40px;
  background: var(--border);
}

.event-info { flex: 1; }

.event-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  line-height: 1.2;
}

.event-desc {
  font-size: 12px;
  color: var(--text3);
  margin-top: 3px;
  font-family: 'Noto Sans Malayalam', sans-serif;
}

.event-countdown {
  font-size: 11px;
  color: var(--teal2);
  margin-top: 4px;
  font-weight: 600;
}

.reminder-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text3);
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}
.reminder-btn:hover { border-color: var(--gold); color: var(--gold); }
.reminder-btn.set { background: rgba(200,146,42,0.15); border-color: var(--gold2); color: var(--gold2); }

/* â”€â”€â”€ BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-nav {
  margin-top: auto;
  padding: 12px 16px max(12px, env(safe-area-inset-bottom));
  display: flex;
  gap: 8px;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  position: sticky;
  bottom: 0;
}

.nav-btn {
  flex: 1;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 8px;
  color: var(--text3);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.1em;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  transition: all 0.2s;
}
.nav-btn .nav-icon { font-size: 20px; }
.nav-btn:hover { border-color: var(--gold); color: var(--text2); }
.nav-btn.active { background: rgba(200,146,42,0.1); border-color: var(--gold2); color: var(--gold2); }

/* â”€â”€â”€ CALENDAR VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#view-calendar { padding: 0 16px 16px; }

.month-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 0 12px;
}

.month-nav-btn {
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text2);
  width: 36px; height: 36px;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.month-nav-btn:hover { border-color: var(--gold); color: var(--gold); }

.month-title {
  text-align: center;
  font-family: 'Cinzel', serif;
  font-size: 16px;
  color: var(--gold2);
}
.month-title-ml {
  font-family: 'Noto Sans Malayalam', sans-serif;
  font-size: 12px;
  color: var(--text3);
  text-align: center;
}

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
}

.cal-dow {
  text-align: center;
  font-size: 10px;
  letter-spacing: 0.08em;
  color: var(--text3);
  font-family: 'Cinzel', serif;
  padding: 4px 0;
}

.cal-cell {
  aspect-ratio: 1;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.15s;
  background: transparent;
  position: relative;
  border: 1px solid transparent;
}
.cal-cell:not(.empty):hover { background: rgba(200,146,42,0.08); }
.cal-cell.empty { pointer-events: none; }
.cal-cell.today { border-color: var(--gold); color: var(--gold2); }
.cal-cell.nakshatra-day { background: rgba(30,123,110,0.15); }
.cal-cell.nakshatra-day::after { content:''; position:absolute; bottom:3px; width:4px; height:4px; border-radius:50%; background:var(--teal2); }
.cal-cell.festival-day { background: rgba(139,26,47,0.15); }
.cal-cell.festival-day::after { content:''; position:absolute; bottom:3px; width:4px; height:4px; border-radius:50%; background:var(--crimson2); }
.cal-cell.selected { background: rgba(200,146,42,0.2); border-color: var(--gold2); }

.cal-cell-num { font-size: 13px; }
.cal-cell-ml {
  font-family: 'Noto Sans Malayalam', sans-serif;
  font-size: 9px;
  color: var(--text3);
  line-height: 1;
}

/* â”€â”€â”€ REMINDERS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#view-reminders { padding: 0 16px 16px; }

.reminder-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.reminder-item-info { flex: 1; }
.reminder-item-name { font-size: 16px; font-weight: 600; color: var(--text); }
.reminder-item-date { font-size: 12px; color: var(--text3); margin-top: 2px; }
.reminder-item-del {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text3);
  width: 32px; height: 32px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.reminder-item-del:hover { border-color: var(--crimson2); color: var(--crimson2); }

.empty-state {
  text-align: center;
  color: var(--text3);
  padding: 40px 20px;
  font-size: 15px;
}
.empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--bg3);
  border: 1px solid var(--gold);
  color: var(--gold2);
  padding: 10px 20px;
  border-radius: 30px;
  font-size: 13px;
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
  white-space: nowrap;
  z-index: 100;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.legend {
  display: flex;
  gap: 12px;
  padding: 8px 16px 0;
  flex-wrap: wrap;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--text3);
}
.legend-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
}

/* â”€â”€â”€ VIEWS TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.view { display: none; }
.view.active { display: block; }

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* â”€â”€â”€ PERMISSION BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.perm-banner {
  margin: 10px 16px 0;
  background: linear-gradient(135deg, rgba(200,146,42,0.12), rgba(200,146,42,0.06));
  border: 1px solid rgba(200,146,42,0.3);
  border-radius: 12px;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--text2);
}
.perm-banner-btn {
  background: var(--gold);
  color: var(--bg);
  border: none;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  font-family: 'Cinzel', serif;
  letter-spacing: 0.05em;
  flex-shrink: 0;
}
.perm-banner.hidden { display: none; }

/* Fade-in animation */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.event-card { animation: fadeUp 0.3s ease both; }
.event-card:nth-child(1) { animation-delay: 0.0s; }
.event-card:nth-child(2) { animation-delay: 0.05s; }
.event-card:nth-child(3) { animation-delay: 0.1s; }
.event-card:nth-child(4) { animation-delay: 0.15s; }
.event-card:nth-child(5) { animation-delay: 0.2s; }
</style>
</head>
<body>
<div id="app">

  <!-- HEADER -->
  <header>
    <div class="header-ornament">
      <span class="moon-icon">ğŸŒ™</span>
    </div>
    <h1>NAKSHATRAM</h1>
    <div class="subtitle">Kerala Panchang & Star Reminders</div>
  </header>

  <!-- NOTIFICATION PERMISSION BANNER -->
  <div class="perm-banner hidden" id="permBanner">
    <span>ğŸ”” Enable notifications for reminders</span>
    <button class="perm-banner-btn" onclick="requestNotifPerm()">Enable</button>
  </div>

  <!-- TODAY CARD -->
  <div class="today-card" id="todayCard">
    <div class="today-label">TODAY</div>
    <div class="today-date-row">
      <div>
        <div class="today-ml-date" id="todayMlDate">â€”</div>
        <div class="today-ml-year" id="todayMlYear">â€”</div>
      </div>
      <div class="today-nakshatra-badge">
        <div class="nakshatra-tag" id="todayNakTag">â€”</div>
        <div class="nakshatra-ml" id="todayNakMl">â€”</div>
      </div>
    </div>
    <div class="panchang-row" id="panchangRow">
      <div class="p-item">
        <div class="p-item-label">Tithi</div>
        <div class="p-item-value" id="todayTithi">â€”</div>
      </div>
      <div class="p-item">
        <div class="p-item-label">Paksha</div>
        <div class="p-item-value" id="todayPaksha">â€”</div>
      </div>
      <div class="p-item">
        <div class="p-item-label">Yoga</div>
        <div class="p-item-value" id="todayYoga">â€”</div>
      </div>
    </div>
  </div>

  <!-- VIEWS -->
  <div id="view-home" class="view active">
    <div class="section-title">Your Birth Star</div>
    <div class="nakshatra-selector">
      <div class="selector-card">
        <div class="selector-header" onclick="toggleNakshatraGrid()">
          <span class="selector-icon" id="selIcon">â­</span>
          <div class="selector-info">
            <div class="selector-name" id="selName">Select your Nakshatra</div>
            <div class="selector-detail" id="selDetail">Tap to choose your birth star</div>
          </div>
          <span class="selector-chevron" id="selChevron">â–¼</span>
        </div>
        <div class="nakshatra-grid" id="nakshatraGrid"></div>
      </div>
    </div>

    <div class="section-title">Upcoming Events</div>
    <div class="events-list" id="eventsList">
      <div class="empty-state">
        <div class="empty-icon">ğŸŒ™</div>
        Select your birth star above to see upcoming auspicious dates
      </div>
    </div>
  </div>

  <div id="view-calendar" class="view">
    <div class="month-nav">
      <button class="month-nav-btn" onclick="changeCalMonth(-1)">â€¹</button>
      <div>
        <div class="month-title" id="calMonthTitle">â€”</div>
        <div class="month-title-ml" id="calMonthMl">â€”</div>
      </div>
      <button class="month-nav-btn" onclick="changeCalMonth(1)">â€º</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--teal2)"></div> Your Nakshatra</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--crimson2)"></div> Festival</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--gold2);border-radius:2px;width:10px;height:10px;"></div> Today</div>
    </div>
  </div>

  <div id="view-reminders" class="view">
    <div class="section-title" style="padding-top:12px">Your Reminders</div>
    <div id="remindersList"></div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('home',this)">
      <span class="nav-icon">ğŸŒ™</span>Today
    </button>
    <button class="nav-btn" onclick="switchView('calendar',this)">
      <span class="nav-icon">ğŸ“…</span>Calendar
    </button>
    <button class="nav-btn" onclick="switchView('reminders',this)">
      <span class="nav-icon">ğŸ””</span>Reminders
    </button>
  </nav>

</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const NAKSHATRAS = [
  { id:0, name:'Ashwini',      ml:'à´…à´¶àµà´µà´¤à´¿',       symbol:'ğŸ´', deity:'Ashwini Kumaras', lord:'Ketu'   },
  { id:1, name:'Bharani',      ml:'à´­à´°à´£à´¿',          symbol:'ğŸ”±', deity:'Yama',            lord:'Venus'  },
  { id:2, name:'Krittika',     ml:'à´•à´¾àµ¼à´¤àµà´¤à´¿à´•',     symbol:'ğŸ”¥', deity:'Agni',            lord:'Sun'    },
  { id:3, name:'Rohini',       ml:'à´°àµ‹à´¹à´¿à´£à´¿',       symbol:'ğŸŒ¸', deity:'Brahma',          lord:'Moon'   },
  { id:4, name:'Mrigashira',   ml:'à´®à´•à´¯à´¿à´°à´‚',       symbol:'ğŸ¦Œ', deity:'Soma',            lord:'Mars'   },
  { id:5, name:'Ardra',        ml:'à´¤à´¿à´°àµà´µà´¾à´¤à´¿à´°',    symbol:'ğŸ’', deity:'Rudra',           lord:'Rahu'   },
  { id:6, name:'Punarvasu',    ml:'à´ªàµà´£àµ¼à´¤à´‚',       symbol:'ğŸ¹', deity:'Aditi',           lord:'Jupiter'},
  { id:7, name:'Pushya',       ml:'à´ªàµ‚à´¯à´‚',          symbol:'ğŸŒ¼', deity:'Brihaspati',      lord:'Saturn' },
  { id:8, name:'Ashlesha',     ml:'à´†à´¯à´¿à´²àµà´¯à´‚',      symbol:'ğŸ', deity:'Nagas',           lord:'Mercury'},
  { id:9, name:'Magha',        ml:'à´®à´•à´‚',           symbol:'ğŸ‘‘', deity:'Pitrs',           lord:'Ketu'   },
  { id:10, name:'Purva Phalguni', ml:'à´ªàµ‚à´°à´‚',      symbol:'ğŸ›ï¸', deity:'Bhaga',           lord:'Venus'  },
  { id:11, name:'Uttara Phalguni',ml:'à´‰à´¤àµà´°à´‚',     symbol:'ğŸ›ï¸', deity:'Aryaman',         lord:'Sun'    },
  { id:12, name:'Hasta',       ml:'à´…à´¤àµà´¤à´‚',        symbol:'âœ‹', deity:'Savitar',         lord:'Moon'   },
  { id:13, name:'Chitra',      ml:'à´šà´¿à´¤àµà´¤à´¿à´°',     symbol:'ğŸ’', deity:'Vishwakarma',     lord:'Mars'   },
  { id:14, name:'Swati',       ml:'à´šàµ‹à´¤à´¿',         symbol:'ğŸŒ¿', deity:'Vayu',            lord:'Rahu'   },
  { id:15, name:'Vishakha',    ml:'à´µà´¿à´¶à´¾à´–à´‚',       symbol:'âš¡', deity:'Indra-Agni',      lord:'Jupiter'},
  { id:16, name:'Anuradha',    ml:'à´…à´¨à´¿à´´à´‚',        symbol:'ğŸŒ¹', deity:'Mitra',           lord:'Saturn' },
  { id:17, name:'Jyeshtha',    ml:'à´¤àµƒà´•àµà´•àµ‡à´Ÿàµà´Ÿ',   symbol:'ğŸ”±', deity:'Indra',           lord:'Mercury'},
  { id:18, name:'Mula',        ml:'à´®àµ‚à´²à´‚',          symbol:'ğŸŒ¿', deity:'Nirriti',         lord:'Ketu'   },
  { id:19, name:'Purva Ashadha',ml:'à´ªàµ‚à´°à´¾à´Ÿà´‚',     symbol:'ğŸ˜', deity:'Apas',            lord:'Venus'  },
  { id:20, name:'Uttara Ashadha',ml:'à´‰à´¤àµà´°à´¾à´Ÿà´‚',   symbol:'ğŸ˜', deity:'Vishwadevas',     lord:'Sun'    },
  { id:21, name:'Shravana',    ml:'à´¤à´¿à´°àµà´µàµ‹à´£à´‚',    symbol:'ğŸ‘‚', deity:'Vishnu',          lord:'Moon'   },
  { id:22, name:'Dhanishta',   ml:'à´…à´µà´¿à´Ÿàµà´Ÿà´‚',      symbol:'ğŸ¥', deity:'Ashta Vasus',     lord:'Mars'   },
  { id:23, name:'Shatabhisha', ml:'à´šà´¤à´¯à´‚',         symbol:'ğŸŒ€', deity:'Varuna',          lord:'Rahu'   },
  { id:24, name:'Purva Bhadrapada', ml:'à´ªàµ‚à´°àµà´°àµà´Ÿàµà´Ÿà´¾à´¤à´¿', symbol:'âš¡', deity:'Aja Ekapada', lord:'Jupiter'},
  { id:25, name:'Uttara Bhadrapada',ml:'à´‰à´¤àµà´°à´Ÿàµà´Ÿà´¾à´¤à´¿',  symbol:'ğŸ', deity:'Ahirbudhnya',  lord:'Saturn' },
  { id:26, name:'Revati',      ml:'à´°àµ‡à´µà´¤à´¿',        symbol:'ğŸŸ', deity:'Pushan',          lord:'Mercury'},
];

const ML_MONTHS = [
  'Chingam','Kanni','Thulam','Vrischikam','Dhanu','Makaram',
  'Kumbham','Meenam','Medam','Idavam','Midhunam','Karkidakam'
];
const ML_MONTHS_ML = [
  'à´šà´¿à´™àµà´™à´‚','à´•à´¨àµà´¨à´¿','à´¤àµà´²à´¾à´‚','à´µàµƒà´¶àµà´šà´¿à´•à´‚','à´§à´¨àµ','à´®à´•à´°à´‚',
  'à´•àµà´‚à´­à´‚','à´®àµ€à´¨à´‚','à´®àµ‡à´Ÿà´‚','à´‡à´Ÿà´µà´‚','à´®à´¿à´¥àµà´¨à´‚','à´•àµ¼à´•àµà´•à´Ÿà´•à´‚'
];

// Kerala special festivals with their Nakshatra association
const FESTIVALS = [
  { name:'Thiruvonam',    ml:'à´¤à´¿à´°àµà´µàµ‹à´£à´‚',    nakIdx:21, month:0,  desc:'Onam â€” Vishnu/Mahabali' },
  { name:'Thiruvathira',  ml:'à´¤à´¿à´°àµà´µà´¾à´¤à´¿à´°',   nakIdx:5,  month:4,  desc:'Shiva festival, Dhanu' },
  { name:'Ashtami Rohini',ml:'à´…à´·àµà´Ÿà´®à´¿ à´°àµ‹à´¹à´¿à´£à´¿', nakIdx:3, month:0, desc:'Janmashtami â€” Krishna' },
  { name:'Uthradam',      ml:'à´‰à´¤àµà´°à´¾à´Ÿà´‚',      nakIdx:20, month:0,  desc:'Day before Onam' },
  { name:'Vishu',         ml:'à´µà´¿à´¶àµ',          nakIdx:null,month:8, fixed:true, day:14, desc:'Kerala New Year, Medam' },
  { name:'Karkidaka Vavu',ml:'à´•àµ¼à´•àµà´•à´Ÿ à´µà´¾à´µàµ',  nakIdx:null,month:11,fixed:'newmoon', desc:'Pitru Tarpanam' },
];

const TITHIS = [
  'Prathama','Dwitiya','Tritiya','Chaturthi','Panchami',
  'Shashti','Saptami','Ashtami','Navami','Dashami',
  'Ekadashi','Dwadashi','Trayodashi','Chaturdashi','Purnima/Amavasya'
];

const YOGAS = [
  'Vishkambha','Priti','Ayushman','Saubhagya','Shobhana',
  'Atiganda','Sukarma','Dhriti','Shula','Ganda',
  'Vriddhi','Dhruva','Vyaghata','Harshana','Vajra',
  'Siddhi','Vyatipata','Variyana','Parigha','Shiva',
  'Siddha','Sadhya','Shubha','Shukla','Brahma',
  'Indra','Vaidhriti'
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASTRONOMICAL CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function jdn(date) {
  const d = date.getDate(), m = date.getMonth()+1, y = date.getFullYear();
  return 367*y - Math.floor(7*(y+Math.floor((m+9)/12))/4)
       + Math.floor(275*m/9) + d + 1721013.5
       + (date.getUTCHours() + 5.5) / 24;
}

function sunLon(jd) {
  const n = jd - 2451545.0;
  const L = (280.460 + 0.9856474*n) % 360;
  const g = ((357.528 + 0.9856003*n) % 360) * Math.PI/180;
  return ((L + 1.915*Math.sin(g) + 0.020*Math.sin(2*g)) % 360 + 360) % 360;
}

function moonLon(jd) {
  const n = jd - 2451545.0;
  const D = (297.8502042 + 12.19074912*n) % 360;
  const M = (357.5291092 + 0.9856002585*n) % 360;
  const Mp = (134.9634114 + 13.06499315*n) % 360;
  const F = (93.2720993 + 13.22935024*n) % 360;
  const toR = Math.PI/180;
  const lon = (218.3165 + 13.1763966*n
    + 6.289*Math.sin(Mp*toR)
    - 1.274*Math.sin((2*D-Mp)*toR)
    + 0.658*Math.sin(2*D*toR)
    - 0.186*Math.sin(M*toR)
    - 0.059*Math.sin((2*D-2*Mp)*toR)
    - 0.057*Math.sin((2*D-M-Mp)*toR)
    + 0.053*Math.sin((2*D+Mp)*toR)
    + 0.046*Math.sin((2*D-M)*toR)
    + 0.041*Math.sin((Mp-M)*toR)) % 360;
  return (lon + 360) % 360;
}

function getNakshatra(date) {
  const jd = jdn(date);
  const ml = moonLon(jd);
  // Add ayanamsha (approx 24 degrees for Lahiri)
  const sid = (ml - 24 + 360) % 360;
  return Math.floor(sid / (360/27));
}

function getTithi(date) {
  const jd = jdn(date);
  const sl = sunLon(jd);
  const ml = moonLon(jd);
  let diff = (ml - sl + 360) % 360;
  return Math.floor(diff / 12);
}

function getPaksha(date) {
  const t = getTithi(date);
  return t < 15 ? 'Shukla' : 'Krishna';
}

function getYoga(date) {
  const jd = jdn(date);
  const sid = (sunLon(jd) - 24 + 360) % 360;
  const mid = (moonLon(jd) - 24 + 360) % 360;
  return Math.floor(((sid + mid) % 360) / (360/27));
}

// Malayalam date approximation (Kollavarsham)
function getMalayalamDate(date) {
  // Sidereal solar longitude gives Malayalam month
  const jd = jdn(date);
  const sl = sunLon(jd);
  const sid = (sl - 24 + 360) % 360; // sidereal
  const monthIdx = Math.floor(sid / 30);
  const dayInMonth = Math.floor(((sid % 30) / 30) * 30) + 1;
  // Kollavarsham year approx
  const ky = date.getFullYear() - 825;
  return {
    month: ML_MONTHS[monthIdx % 12],
    monthMl: ML_MONTHS_ML[monthIdx % 12],
    monthIdx: monthIdx % 12,
    day: Math.min(dayInMonth, 30),
    year: ky,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let selectedNak = parseInt(localStorage.getItem('selectedNak') ?? '-1');
let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
let calOffset = 0; // months offset from today

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function init() {
  registerSW();
  renderNakshatraGrid();
  updateTodayCard();
  if (selectedNak >= 0) {
    updateSelector(selectedNak);
    renderEvents();
  }
  renderReminders();
  checkNotifPerm();
  // Refresh every minute
  setInterval(updateTodayCard, 60000);
}

function registerSW() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TODAY CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateTodayCard() {
  const today = new Date();
  const mlDate = getMalayalamDate(today);
  const nakIdx = getNakshatra(today);
  const nak = NAKSHATRAS[nakIdx];
  const tithi = getTithi(today);
  const paksha = getPaksha(today);
  const yoga = getYoga(today);

  document.getElementById('todayMlDate').textContent =
    `${mlDate.day} ${mlDate.month}`;
  document.getElementById('todayMlYear').textContent =
    `${mlDate.monthMl} â€” KE ${mlDate.year}`;
  document.getElementById('todayNakTag').textContent = nak.name;
  document.getElementById('todayNakMl').textContent = nak.ml;
  document.getElementById('todayTithi').textContent =
    TITHIS[Math.min(tithi, TITHIS.length-1)].slice(0,8);
  document.getElementById('todayPaksha').textContent = paksha;
  document.getElementById('todayYoga').textContent =
    YOGAS[yoga % YOGAS.length].slice(0,8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAKSHATRA SELECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderNakshatraGrid() {
  const grid = document.getElementById('nakshatraGrid');
  grid.innerHTML = NAKSHATRAS.map((n,i) => `
    <div class="nakshatra-cell ${selectedNak===i?'selected':''}" onclick="selectNakshatra(${i})">
      <div class="n-num">${String(i+1).padStart(2,'0')}</div>
      <div class="n-name">${n.name}</div>
      <div class="n-ml">${n.ml}</div>
    </div>
  `).join('');
}

function toggleNakshatraGrid() {
  const grid = document.getElementById('nakshatraGrid');
  const chevron = document.getElementById('selChevron');
  grid.classList.toggle('open');
  chevron.classList.toggle('open');
}

function selectNakshatra(idx) {
  selectedNak = idx;
  localStorage.setItem('selectedNak', idx);
  toggleNakshatraGrid();
  renderNakshatraGrid();
  updateSelector(idx);
  renderEvents();
}

function updateSelector(idx) {
  const n = NAKSHATRAS[idx];
  document.getElementById('selIcon').textContent = n.symbol;
  document.getElementById('selName').textContent = n.name;
  document.getElementById('selDetail').textContent =
    `${n.ml} Â· Lord: ${n.lord} Â· ${n.deity}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS â€” find next 10 occurrences of user's nakshatra + festivals
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderEvents() {
  if (selectedNak < 0) return;
  const list = document.getElementById('eventsList');
  const events = getUpcomingEvents(selectedNak, 60); // next 60 days
  if (!events.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸŒ™</div>No events found in next 60 days.</div>`;
    return;
  }
  list.innerHTML = events.map((ev, i) => eventCardHTML(ev, i)).join('');
}

function getUpcomingEvents(nakIdx, days) {
  const events = [];
  const today = new Date();
  today.setHours(0,0,0,0);

  for (let d = 1; d <= days; d++) {
    const date = new Date(today);
    date.setDate(today.getDate() + d);
    const nak = getNakshatra(date);

    // Janma Nakshatra day (user's birth star)
    if (nak === nakIdx) {
      events.push({
        type: 'janma',
        name: `${NAKSHATRAS[nakIdx].name} Day`,
        desc: `Your birth star Â· ${NAKSHATRAS[nakIdx].ml}`,
        date,
        daysAway: d,
      });
    }

    // Kerala festivals
    const mlDate = getMalayalamDate(date);
    FESTIVALS.forEach(f => {
      if (f.nakIdx !== null && f.nakIdx === nak && f.month === mlDate.monthIdx) {
        events.push({
          type: 'festival',
          name: f.name,
          desc: f.desc,
          date,
          daysAway: d,
        });
      }
      if (f.fixed && f.month === mlDate.monthIdx && mlDate.day === f.day) {
        events.push({
          type: 'festival',
          name: f.name,
          desc: f.desc,
          date,
          daysAway: d,
        });
      }
    });

    // Ekadashi
    const tithi = getTithi(date);
    if (tithi === 10) {
      events.push({
        type: 'monthly',
        name: 'Ekadashi',
        desc: `${getPaksha(date)} paksha fasting day`,
        date,
        daysAway: d,
      });
    }

    // Amavasya (new moon)
    if (tithi === 29 || tithi === 14) {
      const isNew = tithi === 29;
      events.push({
        type: 'vavu',
        name: isNew ? 'Amavasya (Vavu)' : 'Chaturdashi',
        desc: isNew ? 'New Moon Â· Pitru Tarpanam' : 'Krishna Chaturdashi',
        date,
        daysAway: d,
      });
    }

    if (events.length >= 10) break;
  }

  // Sort and deduplicate
  const seen = new Set();
  return events
    .sort((a,b) => a.date - b.date)
    .filter(e => {
      const k = e.date.toDateString() + e.name;
      if (seen.has(k)) return false;
      seen.add(k); return true;
    })
    .slice(0, 8);
}

function eventCardHTML(ev, i) {
  const id = `ev_${ev.date.toDateString().replace(/ /g,'_')}_${ev.name.replace(/ /g,'_')}`;
  const isSet = reminders.some(r => r.id === id);
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const countdown = ev.daysAway === 1 ? 'Tomorrow' :
                    ev.daysAway === 0 ? 'Today' :
                    `In ${ev.daysAway} days`;
  return `
    <div class="event-card type-${ev.type}" onclick="toggleReminder('${id}','${ev.name}',${ev.date.getTime()})">
      <div class="event-date-block">
        <div class="event-day-num">${ev.date.getDate()}</div>
        <div class="event-month-abbr">${months[ev.date.getMonth()]}</div>
      </div>
      <div class="event-divider"></div>
      <div class="event-info">
        <div class="event-name">${ev.name}</div>
        <div class="event-desc">${ev.desc}</div>
        <div class="event-countdown">ğŸ• ${countdown}</div>
      </div>
      <button class="reminder-btn ${isSet?'set':''}" title="${isSet?'Remove reminder':'Set reminder'}">
        ${isSet?'ğŸ””':'ğŸ”•'}
      </button>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleReminder(id, name, timestamp) {
  const existing = reminders.findIndex(r => r.id === id);
  if (existing >= 0) {
    reminders.splice(existing, 1);
    showToast('ğŸ”• Reminder removed');
  } else {
    // Schedule for 7am on the day
    const reminderTime = new Date(timestamp);
    reminderTime.setHours(7, 0, 0, 0);
    reminders.push({
      id,
      title: `ğŸŒ™ ${name} Today`,
      body: `Your Kerala Panchang reminder for ${name}`,
      time: reminderTime.getTime(),
      shown: false,
      name,
      date: new Date(timestamp).toDateString(),
    });
    showToast('ğŸ”” Reminder set for 7:00 AM');
    scheduleNotification(reminders[reminders.length-1]);
  }
  localStorage.setItem('reminders', JSON.stringify(reminders));
  renderEvents();
  renderReminders();
}

function scheduleNotification(r) {
  if (Notification.permission !== 'granted') return;
  const delay = r.time - Date.now();
  if (delay <= 0) return;
  setTimeout(() => {
    new Notification(r.title, { body: r.body, icon: 'ğŸŒ™' });
  }, Math.min(delay, 2147483647));
}

function renderReminders() {
  const el = document.getElementById('remindersList');
  if (!reminders.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”•</div>No reminders set yet.<br>Tap the bell icon on any event to add one.</div>`;
    return;
  }
  const sorted = [...reminders].sort((a,b) => a.time - b.time);
  el.innerHTML = sorted.map(r => `
    <div class="reminder-item">
      <span style="font-size:24px">ğŸ””</span>
      <div class="reminder-item-info">
        <div class="reminder-item-name">${r.name}</div>
        <div class="reminder-item-date">ğŸ“… ${r.date} at 7:00 AM</div>
      </div>
      <button class="reminder-item-del" onclick="deleteReminder('${r.id}')">âœ•</button>
    </div>
  `).join('');
}

function deleteReminder(id) {
  reminders = reminders.filter(r => r.id !== id);
  localStorage.setItem('reminders', JSON.stringify(reminders));
  renderReminders();
  renderEvents();
  showToast('Reminder deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCalendar() {
  const today = new Date();
  const target = new Date(today.getFullYear(), today.getMonth() + calOffset, 1);
  const year = target.getFullYear();
  const month = target.getMonth();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const firstDow = new Date(year, month, 1).getDay();
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  document.getElementById('calMonthTitle').textContent = `${months[month]} ${year}`;
  const mlD = getMalayalamDate(new Date(year, month, 15));
  document.getElementById('calMonthMl').textContent = `${mlD.monthMl} â€” KE ${mlD.year}`;

  const grid = document.getElementById('calGrid');
  const dows = ['Su','Mo','Tu','We','Th','Fr','Sa'];
  let html = dows.map(d => `<div class="cal-dow">${d}</div>`).join('');

  // Empty cells
  for (let i = 0; i < firstDow; i++) html += `<div class="cal-cell empty"></div>`;

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const isToday = date.toDateString() === today.toDateString();
    const nak = getNakshatra(date);
    const isUserNak = nak === selectedNak;
    const mlD = getMalayalamDate(date);
    const isFestival = FESTIVALS.some(f => {
      if (f.nakIdx !== null && f.nakIdx === nak && f.month === mlD.monthIdx) return true;
      if (f.fixed && f.month === mlD.monthIdx && mlD.day === f.day) return true;
      return false;
    });
    const classes = ['cal-cell',
      isToday ? 'today' : '',
      isUserNak ? 'nakshatra-day' : '',
      isFestival ? 'festival-day' : '',
    ].filter(Boolean).join(' ');

    html += `
      <div class="${classes}" title="${NAKSHATRAS[nak].name}">
        <span class="cal-cell-num">${d}</span>
        <span class="cal-cell-ml">${mlD.day}</span>
      </div>`;
  }
  grid.innerHTML = html;
}

function changeCalMonth(delta) {
  calOffset += delta;
  renderCalendar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function checkNotifPerm() {
  const banner = document.getElementById('permBanner');
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') {
    banner.classList.remove('hidden');
  }
}

function requestNotifPerm() {
  Notification.requestPermission().then(p => {
    document.getElementById('permBanner').classList.add('hidden');
    if (p === 'granted') {
      showToast('âœ… Notifications enabled!');
      reminders.forEach(r => scheduleNotification(r));
    } else {
      showToast('Notifications blocked');
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchView(name, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  btn.classList.add('active');
  if (name === 'calendar') renderCalendar();
  if (name === 'reminders') renderReminders();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

init();
</script>
</body>
</html>
