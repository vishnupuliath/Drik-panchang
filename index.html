<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="theme-color" content="#f97316"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Nakshatram"/>
<title>Nakshatram ‚Äî Kerala Panchang</title>
<link rel="manifest" href="manifest.json"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Noto+Sans+Malayalam:wght@400;600&family=Cinzel:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --saffron:    #f97316;
  --saffron2:   #ea6c0a;
  --saffron3:   #fbbf7a;
  --saffronlt:  #fff7ed;
  --saffronlt2: #ffedd5;
  --white:      #ffffff;
  --offwhite:   #fefcf8;
  --border:     #fed7aa;
  --border2:    #fdba74;
  --teal:       #0d9488;
  --teal2:      #14b8a6;
  --teallt:     #f0fdfa;
  --crimson:    #dc2626;
  --crimsonlt:  #fef2f2;
  --text:       #1c1917;
  --text2:      #57534e;
  --text3:      #a8a29e;
  --radius:     16px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%}
body{min-height:100%;background:var(--offwhite);color:var(--text);font-family:'Cormorant Garamond',Georgia,serif;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body::before{content:'';position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse 80% 30% at 50% 0%,rgba(249,115,22,.12) 0%,transparent 60%),url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23f97316' fill-opacity='0.04'%3E%3Cpath d='M20 0l2.5 7.5H30l-6.5 4.75 2.5 7.75L20 15.5l-6 4.5 2.5-7.75L10 7.5h7.5z'/%3E%3C/g%3E%3C/svg%3E");pointer-events:none}
#app{position:relative;z-index:1;max-width:480px;margin:0 auto;min-height:100svh;display:flex;flex-direction:column}

/* HEADER */
header{background:linear-gradient(135deg,var(--saffron) 0%,var(--saffron2) 100%);padding:48px 20px 28px;text-align:center;position:relative;overflow:hidden}
header::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:24px;background:var(--offwhite);clip-path:ellipse(55% 100% at 50% 100%)}
header::before{content:'‚ú¶';position:absolute;font-size:130px;color:rgba(255,255,255,.06);top:-20px;right:-20px}
.header-moon{font-size:36px;margin-bottom:6px;display:block;color:#fff2;text-shadow:0 0 20px rgba(255,255,255,.6),0 2px 8px rgba(0,0,0,.2);letter-spacing:0}
h1{font-family:'Cinzel',serif;font-size:28px;font-weight:600;color:#fff;letter-spacing:.15em;text-shadow:0 2px 8px rgba(0,0,0,.15)}
.subtitle{font-family:'Noto Sans Malayalam',sans-serif;font-size:12px;color:rgba(255,255,255,.8);letter-spacing:.06em;margin-top:4px}

/* TODAY CARD */
.today-card{margin:16px 16px 0;background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:0 2px 16px rgba(249,115,22,.08)}
.today-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.2em;color:var(--saffron);text-transform:uppercase;margin-bottom:10px}
.today-main-row{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.today-ml-date{font-size:22px;font-weight:700;color:var(--text)}
.today-ml-sub{font-family:'Noto Sans Malayalam',sans-serif;font-size:12px;color:var(--text3);margin-top:2px}
.nakshatra-pill{background:var(--saffronlt2);border:1px solid var(--border2);color:var(--saffron2);padding:5px 14px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap}
.nakshatra-pill-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:11px;color:var(--text3);text-align:right;margin-top:3px}
.panchang-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px}
.p-item{background:var(--saffronlt);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
.p-item-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:3px}
.p-item-value{font-size:14px;font-weight:700;color:var(--text)}

/* SECTION TITLE */
.section-title{font-family:'Cinzel',serif;font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:var(--text3);padding:20px 20px 8px;display:flex;align-items:center;gap:8px}
.section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

/* NAKSHATRA SELECTOR */
.nakshatra-selector{padding:0 16px}
.selector-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 8px rgba(249,115,22,.06)}
.selector-header{padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;transition:background .2s}
.selector-header:hover{background:var(--saffronlt)}
.selector-icon{font-size:24px}
.selector-info{flex:1}
.selector-name{font-size:18px;font-weight:700;color:var(--saffron)}
.selector-detail{font-family:'Noto Sans Malayalam',sans-serif;font-size:12px;color:var(--text3);margin-top:2px}
.selector-chevron{color:var(--text3);font-size:16px;transition:transform .3s}
.selector-chevron.open{transform:rotate(180deg)}
.nakshatra-grid{display:none;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-top:1px solid var(--border);max-height:320px;overflow-y:auto}
.nakshatra-grid.open{display:grid}
.nakshatra-cell{background:#fff;padding:10px 8px;cursor:pointer;text-align:center;transition:background .15s}
.nakshatra-cell:hover{background:var(--saffronlt)}
.nakshatra-cell.selected{background:var(--saffronlt2)}
.n-num{font-size:10px;color:var(--text3);font-family:'Cinzel',serif}
.n-name{font-size:13px;color:var(--text);font-weight:700;line-height:1.2;margin-top:2px}
.n-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:11px;color:var(--text3)}
.nakshatra-cell.selected .n-name{color:var(--saffron)}

/* FINDER */
.finder-card{margin:0 16px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 8px rgba(249,115,22,.06)}
.finder-header{background:linear-gradient(135deg,var(--saffronlt2),var(--saffronlt));padding:14px 16px;border-bottom:1px solid var(--border)}
.finder-header-title{font-family:'Cinzel',serif;font-size:14px;font-weight:600;color:var(--saffron2);display:flex;align-items:center;gap:8px}
.finder-header-desc{font-size:12px;color:var(--text3);margin-top:3px}
.finder-body{padding:16px;display:flex;flex-direction:column;gap:12px}
.finder-row{display:flex;gap:10px}
.finder-select-wrap{flex:1;display:flex;flex-direction:column;gap:4px}
.finder-select-label{font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);font-family:'Cinzel',serif}
.finder-select{width:100%;padding:10px 12px;border:1px solid var(--border2);border-radius:10px;background:var(--saffronlt);color:var(--text);font-family:'Cormorant Garamond',Georgia,serif;font-size:15px;font-weight:600;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23f97316' d='M6 8L0 0h12z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;cursor:pointer}
.finder-select:focus{outline:none;border-color:var(--saffron);box-shadow:0 0 0 3px rgba(249,115,22,.1)}
.finder-btn{width:100%;background:linear-gradient(135deg,var(--saffron),var(--saffron2));color:#fff;border:none;border-radius:12px;padding:13px;font-family:'Cinzel',serif;font-size:14px;font-weight:600;letter-spacing:.08em;cursor:pointer;transition:all .2s;box-shadow:0 2px 12px rgba(249,115,22,.3)}
.finder-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(249,115,22,.4)}
.finder-btn:active{transform:scale(.99)}
.finder-result{display:none;background:var(--teallt);border:1px solid var(--teal2);border-radius:12px;padding:14px 16px}
.finder-result.visible{display:block}
.finder-result-date{font-size:22px;font-weight:700;color:var(--teal)}
.finder-result-sub{font-size:13px;color:var(--text2);margin-top:3px}
.finder-result-nak{font-family:'Noto Sans Malayalam',sans-serif;font-size:12px;color:var(--text3);margin-top:2px}
.finder-result-actions{margin-top:12px}
.finder-remind-btn{width:100%;background:var(--teal);color:#fff;border:none;border-radius:10px;padding:11px;font-family:'Cinzel',serif;font-size:13px;letter-spacing:.06em;cursor:pointer;transition:background .2s}
.finder-remind-btn:hover{background:var(--teal2)}
.finder-remind-btn.set{background:var(--saffron)}
.finder-no-result{display:none;background:var(--crimsonlt);border:1px solid #fca5a5;border-radius:12px;padding:12px 16px;font-size:13px;color:var(--crimson)}
.finder-no-result.visible{display:block}

/* EVENTS */
.events-list{padding:0 16px;display:flex;flex-direction:column;gap:10px}
.event-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden;transition:box-shadow .2s,transform .15s;box-shadow:0 1px 4px rgba(0,0,0,.04);animation:fadeUp .3s ease both}
.event-card:hover{box-shadow:0 4px 16px rgba(249,115,22,.12);transform:translateY(-1px)}
.event-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:4px 0 0 4px}
.event-card.type-janma::before{background:var(--saffron)}
.event-card.type-festival::before{background:var(--crimson)}
.event-card.type-vavu::before{background:var(--teal)}
.event-card.type-monthly::before{background:#7c3aed}
.event-date-block{display:flex;flex-direction:column;align-items:center;min-width:44px;text-align:center}
.event-day-num{font-size:26px;font-weight:700;line-height:1;color:var(--saffron);font-family:'Cinzel',serif}
.event-month-abbr{font-size:11px;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin-top:2px}
.event-divider{width:1px;height:40px;background:var(--border)}
.event-info{flex:1}
.event-name{font-size:16px;font-weight:700;color:var(--text)}
.event-desc{font-size:12px;color:var(--text3);margin-top:3px;font-family:'Noto Sans Malayalam',sans-serif}
.event-countdown{font-size:11px;color:var(--teal);margin-top:4px;font-weight:700}
.reminder-btn{background:transparent;border:1px solid var(--border);color:var(--text3);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;transition:all .2s;flex-shrink:0}
.reminder-btn:hover{border-color:var(--saffron);color:var(--saffron)}
.reminder-btn.set{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron)}
.event-card:nth-child(1){animation-delay:0s}.event-card:nth-child(2){animation-delay:.05s}.event-card:nth-child(3){animation-delay:.1s}.event-card:nth-child(4){animation-delay:.15s}.event-card:nth-child(5){animation-delay:.2s}

/* CALENDAR */
#view-calendar{padding:0 16px 16px}
.month-nav{display:flex;align-items:center;justify-content:space-between;padding:4px 0 12px}
.month-nav-btn{background:#fff;border:1px solid var(--border);color:var(--saffron);width:36px;height:36px;border-radius:10px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.month-nav-btn:hover{background:var(--saffronlt)}
.month-title{font-family:'Cinzel',serif;font-size:16px;color:var(--text);text-align:center}
.month-title-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:12px;color:var(--text3);text-align:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-dow{text-align:center;font-size:10px;letter-spacing:.08em;color:var(--text3);font-family:'Cinzel',serif;padding:4px 0}
.cal-cell{aspect-ratio:1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;cursor:pointer;transition:background .15s;border:1px solid transparent;background:transparent;position:relative}
.cal-cell:not(.empty):hover{background:var(--saffronlt)}
.cal-cell.empty{pointer-events:none}
.cal-cell.today{border-color:var(--saffron);background:var(--saffronlt);color:var(--saffron);font-weight:700}
.cal-cell.nakshatra-day{background:rgba(20,184,166,.1)}
.cal-cell.nakshatra-day::after{content:'';position:absolute;bottom:3px;width:4px;height:4px;border-radius:50%;background:var(--teal2)}
.cal-cell.festival-day{background:rgba(220,38,38,.06)}
.cal-cell.festival-day::after{content:'';position:absolute;bottom:3px;width:4px;height:4px;border-radius:50%;background:var(--crimson)}
.cal-cell-num{font-size:13px;font-weight:600}
.cal-cell-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:9px;color:var(--text3);line-height:1}
.legend{display:flex;gap:12px;padding:10px 0 0;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)}
.legend-dot{width:8px;height:8px;border-radius:50%}

/* REMINDERS */
#view-reminders{padding:0 16px 16px}
.reminder-item{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.reminder-dot{width:10px;height:10px;border-radius:50%;background:var(--saffron);flex-shrink:0}
.reminder-item-info{flex:1}
.reminder-item-name{font-size:16px;font-weight:700;color:var(--text)}
.reminder-item-date{font-size:12px;color:var(--text3);margin-top:2px}
.reminder-item-del{background:transparent;border:1px solid var(--border);color:var(--text3);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.reminder-item-del:hover{border-color:var(--crimson);color:var(--crimson)}

/* BOTTOM NAV */
.bottom-nav{margin-top:auto;padding:10px 16px max(10px,env(safe-area-inset-bottom));display:flex;gap:8px;border-top:1px solid var(--border);background:#fff;position:sticky;bottom:0;box-shadow:0 -2px 12px rgba(0,0,0,.06)}
.nav-btn{flex:1;background:transparent;border:1px solid var(--border);border-radius:12px;padding:10px 8px;color:var(--text3);font-family:'Cinzel',serif;font-size:11px;letter-spacing:.1em;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all .2s}
.nav-btn .nav-icon{font-size:20px}
.nav-btn:hover{border-color:var(--saffron);color:var(--saffron2)}
.nav-btn.active{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron)}

/* PERM BANNER */
.perm-banner{margin:10px 16px 0;background:var(--saffronlt);border:1px solid var(--border2);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text2)}
.perm-banner-btn{background:var(--saffron);color:#fff;border:none;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Cinzel',serif;flex-shrink:0}
.perm-banner.hidden{display:none}

/* TOAST */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--text);color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;z-index:100}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* VIEWS */
.view{display:none}
.view.active{display:block}
.empty-state{text-align:center;color:var(--text3);padding:40px 20px;font-size:15px}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}

@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* RECURRING VIEW */
#view-recurring{padding:0 16px 16px}
.recur-builder{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 8px rgba(249,115,22,.06);margin-bottom:12px}
.recur-builder-header{background:linear-gradient(135deg,var(--saffronlt2),var(--saffronlt));padding:14px 16px;border-bottom:1px solid var(--border)}
.recur-builder-title{font-family:'Cinzel',serif;font-size:14px;font-weight:600;color:var(--saffron2)}
.recur-builder-desc{font-size:12px;color:var(--text3);margin-top:3px}
.recur-body{padding:16px;display:flex;flex-direction:column;gap:12px}
.recur-row{display:flex;gap:10px;align-items:flex-end}
.recur-toggle-row{display:flex;gap:6px}
.recur-toggle{flex:1;padding:9px 6px;border:1px solid var(--border2);border-radius:10px;background:var(--saffronlt);color:var(--text3);font-family:'Cinzel',serif;font-size:11px;letter-spacing:.06em;cursor:pointer;text-align:center;transition:all .2s}
.recur-toggle.active{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron);font-weight:700}
.recur-match-row{display:flex;gap:8px}
.recur-match-btn{flex:1;padding:9px;border:1px solid var(--border2);border-radius:10px;background:var(--saffronlt);color:var(--text3);font-family:'Cinzel',serif;font-size:11px;cursor:pointer;transition:all .2s;text-align:center}
.recur-match-btn.active{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron);font-weight:700}
.recur-select{width:100%;padding:10px 12px;border:1px solid var(--border2);border-radius:10px;background:var(--saffronlt);color:var(--text);font-family:'Cormorant Garamond',Georgia,serif;font-size:15px;font-weight:600;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23f97316' d='M6 8L0 0h12z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;cursor:pointer}
.recur-select:disabled{opacity:.4;cursor:not-allowed}
.recur-select:focus{outline:none;border-color:var(--saffron)}
.recur-time-row{display:flex;gap:10px;align-items:center}
.recur-time-label{font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);font-family:'Cinzel',serif;white-space:nowrap}
.recur-time-input{flex:1;padding:10px 12px;border:1px solid var(--border2);border-radius:10px;background:var(--saffronlt);color:var(--text);font-size:15px;font-weight:600;font-family:'Cormorant Garamond',serif}
.recur-time-input:focus{outline:none;border-color:var(--saffron)}
.recur-preview{background:var(--teallt);border:1px solid var(--teal2);border-radius:12px;padding:14px 16px;display:none}
.recur-preview.visible{display:block}
.recur-preview-title{font-family:'Cinzel',serif;font-size:11px;letter-spacing:.15em;text-transform:uppercase;color:var(--teal);margin-bottom:10px}
.recur-occ{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(20,184,166,.15)}
.recur-occ:last-child{border-bottom:none}
.recur-occ-date{font-size:15px;font-weight:700;color:var(--teal);min-width:90px}
.recur-occ-detail{font-size:12px;color:var(--text2);flex:1}
.recur-occ-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:11px;color:var(--text3)}
.recur-add-btn{width:100%;background:linear-gradient(135deg,var(--saffron),var(--saffron2));color:#fff;border:none;border-radius:12px;padding:13px;font-family:'Cinzel',serif;font-size:14px;font-weight:600;letter-spacing:.08em;cursor:pointer;transition:all .2s;box-shadow:0 2px 12px rgba(249,115,22,.3)}
.recur-add-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(249,115,22,.4)}
.recur-add-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.recur-rule-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.recur-rule-header{display:flex;align-items:flex-start;gap:10px}
.recur-rule-icon{font-size:24px;flex-shrink:0}
.recur-rule-info{flex:1}
.recur-rule-name{font-size:16px;font-weight:700;color:var(--text)}
.recur-rule-detail{font-size:12px;color:var(--text3);margin-top:2px;font-family:'Noto Sans Malayalam',sans-serif}
.recur-rule-next{font-size:12px;color:var(--teal);margin-top:4px;font-weight:600}
.recur-rule-del{background:transparent;border:1px solid var(--border);color:var(--text3);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.recur-rule-del:hover{border-color:var(--crimson);color:var(--crimson)}
.recur-rule-upcoming{margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.recur-rule-occ-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px}
.recur-rule-occ-date{color:var(--text);font-weight:600}
.recur-rule-occ-cd{color:var(--teal);font-size:11px}

/* ‚îÄ‚îÄ DAY DETAIL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal-sheet{width:100%;max-width:480px;background:var(--offwhite);border-radius:24px 24px 0 0;padding:0 0 max(20px,env(safe-area-inset-bottom));max-height:92svh;overflow-y:auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,1,.23,1)}
.modal-overlay.open .modal-sheet{transform:translateY(0)}
.modal-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:12px auto 0}
.modal-header{background:linear-gradient(135deg,var(--saffron),var(--saffron2));padding:16px 20px 20px;margin:0;position:relative;overflow:hidden}
.modal-header::before{content:'‚ú¶';position:absolute;font-size:100px;color:rgba(255,255,255,.07);top:-10px;right:-10px}
.modal-header-close{position:absolute;top:12px;right:14px;background:rgba(255,255,255,.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}
.modal-header-close:hover{background:rgba(255,255,255,.35)}
.modal-greg-date{font-family:'Cinzel',serif;font-size:22px;font-weight:600;color:#fff;letter-spacing:.08em}
.modal-ml-date{font-family:'Noto Sans Malayalam',sans-serif;font-size:14px;color:rgba(255,255,255,.85);margin-top:3px}
.modal-day-name{font-size:12px;color:rgba(255,255,255,.7);letter-spacing:.1em;text-transform:uppercase;font-family:'Cinzel',serif;margin-bottom:8px}

.modal-body{padding:16px}
.modal-section{margin-bottom:14px}
.modal-section-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.2em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.modal-section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

.modal-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.modal-detail-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;cursor:pointer;transition:all .2s;position:relative}
.modal-detail-card:hover{border-color:var(--saffron);box-shadow:0 2px 10px rgba(249,115,22,.12)}
.modal-detail-card.selected{background:var(--saffronlt2);border-color:var(--saffron)}
.modal-detail-card.selected::after{content:'‚úì';position:absolute;top:6px;right:8px;font-size:12px;color:var(--saffron);font-weight:700}
.modal-detail-type{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:3px}
.modal-detail-en{font-size:15px;font-weight:700;color:var(--text);line-height:1.2}
.modal-detail-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:12px;color:var(--text3);margin-top:2px}
.modal-detail-sub{font-size:11px;color:var(--text3);margin-top:2px}

.modal-festivals{display:flex;flex-direction:column;gap:6px}
.modal-festival-tag{background:var(--crimsonlt);border:1px solid #fca5a5;border-radius:8px;padding:8px 12px;font-size:13px;color:var(--crimson);display:flex;align-items:center;gap:8px}
.modal-festival-ml{font-family:'Noto Sans Malayalam',sans-serif;font-size:11px;color:var(--text3)}

.modal-notif-section{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-top:4px}
.modal-notif-title{font-family:'Cinzel',serif;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--saffron);margin-bottom:4px}
.modal-notif-desc{font-size:12px;color:var(--text3);margin-bottom:12px}
.modal-notif-selection{font-size:13px;color:var(--text2);margin-bottom:10px;min-height:18px}
.modal-notif-selection span{color:var(--saffron);font-weight:700}

.modal-notif-type-row{display:flex;gap:6px;margin-bottom:10px}
.modal-notif-type-btn{flex:1;padding:7px;border:1px solid var(--border2);border-radius:8px;background:var(--saffronlt);color:var(--text3);font-size:11px;font-family:'Cinzel',serif;cursor:pointer;text-align:center;transition:all .2s;letter-spacing:.04em}
.modal-notif-type-btn.active{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron);font-weight:700}


.modal-offset-row{display:flex;gap:6px;margin-bottom:10px}
.modal-offset-btn{flex:1;padding:8px 6px;border:1px solid var(--border2);border-radius:9px;background:var(--saffronlt);color:var(--text3);font-family:'Cinzel',serif;font-size:11px;letter-spacing:.05em;cursor:pointer;text-align:center;transition:all .2s}
.modal-offset-btn.active{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron);font-weight:700}
.recur-offset-row{display:flex;gap:6px}
.recur-offset-btn{flex:1;padding:7px 4px;border:1px solid var(--border2);border-radius:9px;background:var(--saffronlt);color:var(--text3);font-family:'Cinzel',serif;font-size:10px;letter-spacing:.04em;cursor:pointer;text-align:center;transition:all .2s}
.recur-offset-btn.active{background:var(--saffronlt2);border-color:var(--saffron);color:var(--saffron);font-weight:700}
.modal-time-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.modal-time-label{font-size:11px;color:var(--text3);font-family:'Cinzel',serif;letter-spacing:.08em;text-transform:uppercase;white-space:nowrap}
.modal-time-input{flex:1;padding:9px 12px;border:1px solid var(--border2);border-radius:10px;background:var(--saffronlt);color:var(--text);font-size:14px;font-weight:600}
.modal-time-input:focus{outline:none;border-color:var(--saffron)}

.modal-btn-row{display:flex;gap:8px}
.modal-one-btn{flex:1;background:var(--teal);color:#fff;border:none;border-radius:10px;padding:11px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:.06em;cursor:pointer;transition:background .2s}
.modal-one-btn:hover{background:var(--teal2)}
.modal-recur-btn{flex:1;background:linear-gradient(135deg,var(--saffron),var(--saffron2));color:#fff;border:none;border-radius:10px;padding:11px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:.06em;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(249,115,22,.25)}
.modal-recur-btn:hover{transform:translateY(-1px)}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>
<div id="app">

<header>
  <span class="header-moon">Âçê</span>
  <h1>NAKSHATRAM</h1>
  <div class="subtitle">Kerala Panchang ¬∑ ‡¥®‡¥ï‡µç‡¥∑‡¥§‡µç‡¥∞ ‡¥ì‡µº‡¥Æ‡µç‡¥Æ‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥§‡µç‡¥§‡µΩ</div>
</header>

<div class="perm-banner hidden" id="permBanner">
  <span>üîî Enable notifications for reminders</span>
  <button class="perm-banner-btn" onclick="requestNotifPerm()">Enable</button>
</div>

<div class="today-card">
  <div class="today-label">‚ú¶ Today's Panchang</div>
  <div class="today-main-row">
    <div>
      <div class="today-ml-date" id="todayMlDate">Loading‚Ä¶</div>
      <div class="today-ml-sub" id="todayMlYear">‚Äî</div>
    </div>
    <div>
      <div class="nakshatra-pill" id="todayNakTag">‚Äî</div>
      <div class="nakshatra-pill-ml" id="todayNakMl">‚Äî</div>
    </div>
  </div>
  <div class="panchang-row">
    <div class="p-item"><div class="p-item-label">Tithi</div><div class="p-item-value" id="todayTithi">‚Äî</div></div>
    <div class="p-item"><div class="p-item-label">Paksha</div><div class="p-item-value" id="todayPaksha">‚Äî</div></div>
    <div class="p-item"><div class="p-item-label">Yoga</div><div class="p-item-value" id="todayYoga">‚Äî</div></div>
  </div>
</div>

<!-- HOME VIEW -->
<div id="view-home" class="view active">

  <div class="section-title">Your Birth Star</div>
  <div class="nakshatra-selector">
    <div class="selector-card">
      <div class="selector-header" onclick="toggleNakshatraGrid()">
        <span class="selector-icon" id="selIcon">‚≠ê</span>
        <div class="selector-info">
          <div class="selector-name" id="selName">Select your Nakshatra</div>
          <div class="selector-detail" id="selDetail">Tap to choose your birth star</div>
        </div>
        <span class="selector-chevron" id="selChevron">‚ñº</span>
      </div>
      <div class="nakshatra-grid" id="nakshatraGrid"></div>
    </div>
  </div>

  <div class="section-title">Find a Date</div>
  <div class="finder-card">
    <div class="finder-header">
      <div class="finder-header-title">üìÖ Malayalam Month + Nakshatra ‚Üí Date</div>
      <div class="finder-header-desc">Find when a nakshatra falls in a given Malayalam month & set a reminder</div>
    </div>
    <div class="finder-body">
      <div class="finder-row">
        <div class="finder-select-wrap">
          <label class="finder-select-label">Malayalam Month</label>
          <select class="finder-select" id="finderMonth"></select>
        </div>
        <div class="finder-select-wrap">
          <label class="finder-select-label">Nakshatra</label>
          <select class="finder-select" id="finderNak"></select>
        </div>
      </div>
      <button class="finder-btn" onclick="findDate()">üîç Find Date</button>
      <div class="finder-result" id="finderResult">
        <div class="finder-result-date" id="finderResultDate">‚Äî</div>
        <div class="finder-result-sub" id="finderResultSub">‚Äî</div>
        <div class="finder-result-nak" id="finderResultNak">‚Äî</div>
        <div class="finder-result-actions">
          <button class="finder-remind-btn" id="finderRemindBtn" onclick="setFinderReminder()">üîî Set Reminder for this date</button>
        </div>
      </div>
      <div class="finder-no-result" id="finderNoResult">
        No occurrence found in the next 13 months. Try a different combination.
      </div>
    </div>
  </div>

  <div class="section-title">Upcoming Events</div>
  <div class="events-list" id="eventsList">
    <div class="empty-state">
      <div class="empty-icon">üåô</div>
      Select your birth star above to see upcoming auspicious dates
    </div>
  </div>

</div>

<!-- CALENDAR VIEW -->
<div id="view-calendar" class="view">
  <div class="month-nav">
    <button class="month-nav-btn" onclick="changeCalMonth(-1)">‚Äπ</button>
    <div>
      <div class="month-title" id="calMonthTitle">‚Äî</div>
      <div class="month-title-ml" id="calMonthMl">‚Äî</div>
    </div>
    <button class="month-nav-btn" onclick="changeCalMonth(1)">‚Ä∫</button>
  </div>
  <div class="cal-grid" id="calGrid"></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--teal2)"></div>Your Nakshatra</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--crimson)"></div>Festival</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--saffron);border-radius:2px;width:10px;height:10px"></div>Today</div>
  </div>
</div>

<!-- REMINDERS VIEW -->
<div id="view-reminders" class="view">
  <div class="section-title" style="padding-top:12px">Your Reminders</div>
  <div id="remindersList"></div>
</div>


<!-- RECURRING VIEW -->
<div id="view-recurring" class="view">
  <div class="section-title" style="padding-top:12px">New Recurring Reminder</div>
  <div class="recur-builder">
    <div class="recur-builder-header">
      <div class="recur-builder-title">üîÅ Tithi &amp; Nakshatra Recurring Alerts</div>
      <div class="recur-builder-desc">Get notified every time a Tithi or Nakshatra repeats throughout the year</div>
    </div>
    <div class="recur-body">

      <!-- What to track -->
      <div>
        <div class="finder-select-label" style="margin-bottom:6px">What to track</div>
        <div class="recur-toggle-row">
          <div class="recur-toggle active" id="rtTithi" onclick="toggleRecurType('tithi')">Tithi</div>
          <div class="recur-toggle active" id="rtNak" onclick="toggleRecurType('nak')">Nakshatra</div>
        </div>
      </div>

      <!-- Tithi select -->
      <div id="recurTithiWrap">
        <div class="finder-select-label" style="margin-bottom:4px">Tithi</div>
        <select class="recur-select" id="recurTithiSel"></select>
      </div>

      <!-- Nakshatra select -->
      <div id="recurNakWrap">
        <div class="finder-select-label" style="margin-bottom:4px">Nakshatra</div>
        <select class="recur-select" id="recurNakSel"></select>
      </div>

      <!-- Match mode (shown only when both selected) -->
      <div id="recurMatchWrap" style="display:none">
        <div class="finder-select-label" style="margin-bottom:6px">When to notify</div>
        <div class="recur-match-row">
          <div class="recur-match-btn active" id="rmBoth" onclick="setRecurMatch('both')">Both match</div>
          <div class="recur-match-btn" id="rmEither" onclick="setRecurMatch('either')">Either matches</div>
        </div>
      </div>

      <!-- Notification timing -->
      <div>
        <div class="finder-select-label" style="margin-bottom:6px">When to notify</div>
        <div class="recur-offset-row" style="margin-bottom:10px">
          <div class="recur-offset-btn active" id="roDayOf"  onclick="setRecurOffset(0)">üìÖ Day of event</div>
          <div class="recur-offset-btn"        id="roDayBef" onclick="setRecurOffset(-1)">üåÖ Day before</div>
        </div>
      </div>
      <div class="recur-time-row">
        <span class="recur-time-label">Notify at</span>
        <input type="time" class="recur-time-input" id="recurTime" value="07:00"/>
      </div>

      <!-- Preview button -->
      <button class="recur-add-btn" style="background:linear-gradient(135deg,var(--teal),var(--teal2))" onclick="previewRecur()">üëÅ Preview Upcoming Dates</button>

      <!-- Preview results -->
      <div class="recur-preview" id="recurPreview">
        <div class="recur-preview-title">Next Occurrences</div>
        <div id="recurPreviewList"></div>
      </div>

      <!-- Add button -->
      <button class="recur-add-btn" id="recurAddBtn" onclick="addRecurRule()">üîÅ Save Recurring Reminder</button>
    </div>
  </div>

  <div class="section-title">Active Recurring Reminders</div>
  <div id="recurRulesList">
    <div class="empty-state"><div class="empty-icon">üîÅ</div>No recurring reminders yet.</div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="switchView('home',this)"><span class="nav-icon">Âçê</span>Today</button>
  <button class="nav-btn" onclick="switchView('calendar',this)"><span class="nav-icon">üìÖ</span>Calendar</button>
  <button class="nav-btn" onclick="switchView('reminders',this)"><span class="nav-icon">üîî</span>Reminders</button>
  <button class="nav-btn" onclick="switchView('recurring',this)"><span class="nav-icon">üîÅ</span>Recurring</button>
</nav>
</div>
<!-- DAY DETAIL MODAL -->
<div class="modal-overlay" id="dayModal" onclick="closeDayModal(event)">
  <div class="modal-sheet" id="dayModalSheet">
    <div class="modal-handle"></div>
    <div class="modal-header" id="modalHeader">
      <button class="modal-header-close" onclick="closeDayModalDirect()">‚úï</button>
      <div class="modal-day-name" id="modalDayName">‚Äî</div>
      <div class="modal-greg-date" id="modalGregDate">‚Äî</div>
      <div class="modal-ml-date" id="modalMlDate">‚Äî</div>
    </div>
    <div class="modal-body">

      <!-- Panchang details grid ‚Äî each card is selectable -->
      <div class="modal-section">
        <div class="modal-section-label">Panchang Details</div>
        <div class="modal-detail-grid">
          <div class="modal-detail-card" id="mdNak" onclick="toggleModalCard('nak')">
            <div class="modal-detail-type">Nakshatra</div>
            <div class="modal-detail-en" id="mdNakEn">‚Äî</div>
            <div class="modal-detail-ml" id="mdNakMl">‚Äî</div>
            <div class="modal-detail-sub" id="mdNakSub">‚Äî</div>
          </div>
          <div class="modal-detail-card" id="mdTithi" onclick="toggleModalCard('tithi')">
            <div class="modal-detail-type">Tithi</div>
            <div class="modal-detail-en" id="mdTithiEn">‚Äî</div>
            <div class="modal-detail-ml" id="mdTithiMl">‚Äî</div>
            <div class="modal-detail-sub" id="mdTithiSub">‚Äî</div>
          </div>
          <div class="modal-detail-card" id="mdYoga" onclick="toggleModalCard('yoga')">
            <div class="modal-detail-type">Yoga</div>
            <div class="modal-detail-en" id="mdYogaEn">‚Äî</div>
            <div class="modal-detail-ml" id="mdYogaMl">‚Äî</div>
            <div class="modal-detail-sub" id="mdYogaSub">‚Äî</div>
          </div>
          <div class="modal-detail-card" id="mdPaksha" onclick="toggleModalCard('paksha')">
            <div class="modal-detail-type">Paksha</div>
            <div class="modal-detail-en" id="mdPakshaEn">‚Äî</div>
            <div class="modal-detail-ml" id="mdPakshaMl">‚Äî</div>
            <div class="modal-detail-sub" id="mdPakshaSub">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Festivals on this day -->
      <div class="modal-section" id="modalFestSection" style="display:none">
        <div class="modal-section-label">Festivals & Events</div>
        <div class="modal-festivals" id="modalFestList"></div>
      </div>

      <!-- Notification builder -->
      <div class="modal-section">
        <div class="modal-section-label">Set Notification</div>
        <div class="modal-notif-section">
          <div class="modal-notif-title">üîî Notify based on selected criteria</div>
          <div class="modal-notif-desc">Tap one or more details above to select what triggers this notification</div>

          <div class="modal-notif-selection" id="modalSelection">Nothing selected yet ‚Äî tap a detail card above</div>

          <div class="modal-notif-type-row">
            <div class="modal-notif-type-btn active" id="mntOnce" onclick="setModalNotifType('once')">üìÖ This date only</div>
            <div class="modal-notif-type-btn" id="mntRecur" onclick="setModalNotifType('recur')">üîÅ Every time it repeats</div>
          </div>

          <div class="modal-section-label" style="font-size:10px;letter-spacing:.15em;color:var(--text3);font-family:'Cinzel',serif;text-transform:uppercase;margin-bottom:6px">When to notify</div>
          <div class="modal-offset-row">
            <div class="modal-offset-btn active" id="moDayOf"  onclick="setModalOffset(0)">üìÖ Day of event</div>
            <div class="modal-offset-btn"        id="moDayBef" onclick="setModalOffset(-1)">üåÖ Day before</div>
          </div>
          <div class="modal-time-row">
            <span class="modal-time-label">Notify at</span>
            <input type="time" class="modal-time-input" id="modalTime" value="07:00"/>
          </div>

          <div class="modal-btn-row">
            <button class="modal-one-btn" id="modalSaveBtn" onclick="saveModalReminder()">üíæ Save Reminder</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const NAKSHATRAS=[
  {id:0,name:'Ashwini',ml:'‡¥Ö‡¥∂‡µç‡¥µ‡¥§‡¥ø',symbol:'üê¥',lord:'Ketu'},
  {id:1,name:'Bharani',ml:'‡¥≠‡¥∞‡¥£‡¥ø',symbol:'üî±',lord:'Venus'},
  {id:2,name:'Krittika',ml:'‡¥ï‡¥æ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ï',symbol:'üî•',lord:'Sun'},
  {id:3,name:'Rohini',ml:'‡¥∞‡µã‡¥π‡¥ø‡¥£‡¥ø',symbol:'üå∏',lord:'Moon'},
  {id:4,name:'Mrigashira',ml:'‡¥Æ‡¥ï‡¥Ø‡¥ø‡¥∞‡¥Ç',symbol:'ü¶å',lord:'Mars'},
  {id:5,name:'Ardra',ml:'‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡¥æ‡¥§‡¥ø‡¥∞',symbol:'üíé',lord:'Rahu'},
  {id:6,name:'Punarvasu',ml:'‡¥™‡µÅ‡¥£‡µº‡¥§‡¥Ç',symbol:'üèπ',lord:'Jupiter'},
  {id:7,name:'Pushya',ml:'‡¥™‡µÇ‡¥Ø‡¥Ç',symbol:'üåº',lord:'Saturn'},
  {id:8,name:'Ashlesha',ml:'‡¥Ü‡¥Ø‡¥ø‡¥≤‡µç‡¥Ø‡¥Ç',symbol:'üêç',lord:'Mercury'},
  {id:9,name:'Magha',ml:'‡¥Æ‡¥ï‡¥Ç',symbol:'üëë',lord:'Ketu'},
  {id:10,name:'Purva Phalguni',ml:'‡¥™‡µÇ‡¥∞‡¥Ç',symbol:'üõèÔ∏è',lord:'Venus'},
  {id:11,name:'Uttara Phalguni',ml:'‡¥â‡¥§‡µç‡¥∞‡¥Ç',symbol:'üõèÔ∏è',lord:'Sun'},
  {id:12,name:'Hasta',ml:'‡¥Ö‡¥§‡µç‡¥§‡¥Ç',symbol:'‚úã',lord:'Moon'},
  {id:13,name:'Chitra',ml:'‡¥ö‡¥ø‡¥§‡µç‡¥§‡¥ø‡¥∞',symbol:'üíé',lord:'Mars'},
  {id:14,name:'Swati',ml:'‡¥ö‡µã‡¥§‡¥ø',symbol:'üåø',lord:'Rahu'},
  {id:15,name:'Vishakha',ml:'‡¥µ‡¥ø‡¥∂‡¥æ‡¥ñ‡¥Ç',symbol:'‚ö°',lord:'Jupiter'},
  {id:16,name:'Anuradha',ml:'‡¥Ö‡¥®‡¥ø‡¥¥‡¥Ç',symbol:'üåπ',lord:'Saturn'},
  {id:17,name:'Jyeshtha',ml:'‡¥§‡µÉ‡¥ï‡µç‡¥ï‡µá‡¥ü‡µç‡¥ü',symbol:'üî±',lord:'Mercury'},
  {id:18,name:'Mula',ml:'‡¥Æ‡µÇ‡¥≤‡¥Ç',symbol:'üåø',lord:'Ketu'},
  {id:19,name:'Purva Ashadha',ml:'‡¥™‡µÇ‡¥∞‡¥æ‡¥ü‡¥Ç',symbol:'üêò',lord:'Venus'},
  {id:20,name:'Uttara Ashadha',ml:'‡¥â‡¥§‡µç‡¥∞‡¥æ‡¥ü‡¥Ç',symbol:'üêò',lord:'Sun'},
  {id:21,name:'Shravana',ml:'‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡µã‡¥£‡¥Ç',symbol:'üëÇ',lord:'Moon'},
  {id:22,name:'Dhanishta',ml:'‡¥Ö‡¥µ‡¥ø‡¥ü‡µç‡¥ü‡¥Ç',symbol:'ü•Å',lord:'Mars'},
  {id:23,name:'Shatabhisha',ml:'‡¥ö‡¥§‡¥Ø‡¥Ç',symbol:'üåÄ',lord:'Rahu'},
  {id:24,name:'Purva Bhadrapada',ml:'‡¥™‡µÇ‡¥∞‡µÅ‡¥∞‡µÅ‡¥ü‡µç‡¥ü‡¥æ‡¥§‡¥ø',symbol:'‚ö°',lord:'Jupiter'},
  {id:25,name:'Uttara Bhadrapada',ml:'‡¥â‡¥§‡µç‡¥∞‡¥ü‡µç‡¥ü‡¥æ‡¥§‡¥ø',symbol:'üêç',lord:'Saturn'},
  {id:26,name:'Revati',ml:'‡¥∞‡µá‡¥µ‡¥§‡¥ø',symbol:'üêü',lord:'Mercury'},
];
const ML_MONTHS=['Medam','Idavam','Midhunam','Karkidakam','Chingam','Kanni','Thulam','Vrischikam','Dhanu','Makaram','Kumbham','Meenam'];
const ML_MONTHS_ML=['‡¥Æ‡µá‡¥ü‡¥Ç','‡¥á‡¥ü‡¥µ‡¥Ç','‡¥Æ‡¥ø‡¥•‡µÅ‡¥®‡¥Ç','‡¥ï‡µº‡¥ï‡µç‡¥ï‡¥ü‡¥ï‡¥Ç','‡¥ö‡¥ø‡¥ô‡µç‡¥ô‡¥Ç','‡¥ï‡¥®‡µç‡¥®‡¥ø','‡¥§‡µÅ‡¥≤‡¥æ‡¥Ç','‡¥µ‡µÉ‡¥∂‡µç‡¥ö‡¥ø‡¥ï‡¥Ç','‡¥ß‡¥®‡µÅ','‡¥Æ‡¥ï‡¥∞‡¥Ç','‡¥ï‡µÅ‡¥Ç‡¥≠‡¥Ç','‡¥Æ‡µÄ‡¥®‡¥Ç'];
const TITHIS=['Prathama','Dwitiya','Tritiya','Chaturthi','Panchami','Shashti','Saptami','Ashtami','Navami','Dashami','Ekadashi','Dwadashi','Trayodashi','Chaturdashi','Purnima','Prathama','Dwitiya','Tritiya','Chaturthi','Panchami','Shashti','Saptami','Ashtami','Navami','Dashami','Ekadashi','Dwadashi','Trayodashi','Chaturdashi','Amavasya'];
const YOGAS=['Vishkambha','Priti','Ayushman','Saubhagya','Shobhana','Atiganda','Sukarma','Dhriti','Shula','Ganda','Vriddhi','Dhruva','Vyaghata','Harshana','Vajra','Siddhi','Vyatipata','Variyana','Parigha','Shiva','Siddha','Sadhya','Shubha','Shukla','Brahma','Indra','Vaidhriti'];
const FESTIVALS=[
  {name:'Thiruvonam',ml:'‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡µã‡¥£‡¥Ç',nakIdx:21,monthIdx:4,desc:'Onam ‚Äî Vishnu/Mahabali'},
  {name:'Thiruvathira',ml:'‡¥§‡¥ø‡¥∞‡µÅ‡¥µ‡¥æ‡¥§‡¥ø‡¥∞',nakIdx:5,monthIdx:8,desc:'Shiva festival ¬∑ Dhanu'},
  {name:'Ashtami Rohini',ml:'‡¥Ö‡¥∑‡µç‡¥ü‡¥Æ‡¥ø ‡¥∞‡µã‡¥π‡¥ø‡¥£‡¥ø',nakIdx:3,monthIdx:4,desc:'Janmashtami ‚Äî Krishna'},
  {name:'Uthradam',ml:'‡¥â‡¥§‡µç‡¥∞‡¥æ‡¥ü‡¥Ç',nakIdx:20,monthIdx:4,desc:'Day before Onam'},
];

// ASTRONOMY
function jdn(date){const d=date.getDate(),m=date.getMonth()+1,y=date.getFullYear();return 367*y-Math.floor(7*(y+Math.floor((m+9)/12))/4)+Math.floor(275*m/9)+d+1721013.5+(date.getHours()+5.5)/24}
function sunLon(jd){const n=jd-2451545,L=(280.460+.9856474*n)%360,g=((357.528+.9856003*n)%360)*Math.PI/180;return((L+1.915*Math.sin(g)+.02*Math.sin(2*g))%360+360)%360}
function moonLon(jd){const n=jd-2451545,D=(297.8502042+12.19074912*n)%360,Mp=(134.9634114+13.06499315*n)%360,M=(357.5291092+.9856002585*n)%360,r=Math.PI/180,lon=(218.3165+13.1763966*n+6.289*Math.sin(Mp*r)-1.274*Math.sin((2*D-Mp)*r)+.658*Math.sin(2*D*r)-.186*Math.sin(M*r)-.059*Math.sin((2*D-2*Mp)*r)+.053*Math.sin((2*D+Mp)*r)+.046*Math.sin((2*D-M)*r)+.041*Math.sin((Mp-M)*r))%360;return(lon+360)%360}
// Dynamic Lahiri ayanamsha (more accurate than fixed 24¬∞)
function getAyanamsha(jd){return 23.85+(jd-2451545.0)*(50.3/3600/365.25)}
function getNakshatra(date){const jd=jdn(date);return Math.floor(((moonLon(jd)-getAyanamsha(jd)+360)%360)/(360/27))}
function getTithi(date){const jd=jdn(date);return Math.floor(((moonLon(jd)-sunLon(jd)+360)%360)/12)}
function getPaksha(date){return getTithi(date)<15?'Shukla':'Krishna'}
function getYoga(date){const jd=jdn(date),ayan=getAyanamsha(jd),s=((sunLon(jd)-ayan+360)%360)+((moonLon(jd)-ayan+360)%360);return Math.floor((s%360)/(360/27))}
function getMalayalamDate(date){
  const jd=jdn(date),ayan=getAyanamsha(jd);
  // Sidereal solar longitude (0¬∞=Mesha/Aries)
  const sidSun=(sunLon(jd)-ayan+360)%360;
  // Malayalam month: which rasi sun is in (0=Medam, 4=Chingam, etc.)
  const mIdx=Math.floor(sidSun/30)%12;
  // Day within month: degrees into rasi / sun's daily motion (~0.9856¬∞/day)
  const degInRasi=sidSun%30;
  const day=Math.max(1,Math.min(33,Math.floor(degInRasi/0.9856)+1));
  // Kollavarsham year: starts on first day of Chingam each year (~Aug 17)
  const chingamApprox=new Date(date.getFullYear(),7,17);
  const ky=date>=chingamApprox?date.getFullYear()-824:date.getFullYear()-825;
  return{month:ML_MONTHS[mIdx],monthMl:ML_MONTHS_ML[mIdx],monthIdx:mIdx,day,year:ky}
}

// STATE
let selectedNak=parseInt(localStorage.getItem('selectedNak')??'-1');
let reminders=JSON.parse(localStorage.getItem('reminders')||'[]');
let calOffset=0;
let finderFoundDate=null,finderFoundName=null;

function init(){
  try{
    registerSW();
    populateFinderSelects();
    renderNakshatraGrid();
    updateTodayCard();
    if(selectedNak>=0){updateSelector(selectedNak);renderEvents();}
    renderReminders();
    checkNotifPerm();
    initRecurring();
    setInterval(updateTodayCard,60000);
  }catch(e){console.error('Init error:',e);document.getElementById('todayMlDate').textContent='Error: '+e.message}
}

function registerSW(){if('serviceWorker' in navigator)navigator.serviceWorker.register('/Drik-panchang/sw.js').catch(()=>{})}

function updateTodayCard(){
  const t=new Date(),ml=getMalayalamDate(t),nak=getNakshatra(t),tithi=getTithi(t);
  document.getElementById('todayMlDate').textContent=`${ml.day} ${ml.month}`;
  document.getElementById('todayMlYear').textContent=`${ml.monthMl} ‚Äî KE ${ml.year}`;
  document.getElementById('todayNakTag').textContent=NAKSHATRAS[nak].name;
  document.getElementById('todayNakMl').textContent=NAKSHATRAS[nak].ml;
  document.getElementById('todayTithi').textContent=TITHIS[Math.min(tithi,TITHIS.length-1)].slice(0,9);
  document.getElementById('todayPaksha').textContent=getPaksha(t);
  document.getElementById('todayYoga').textContent=YOGAS[getYoga(t)%27].slice(0,9);
}

function renderNakshatraGrid(){
  document.getElementById('nakshatraGrid').innerHTML=NAKSHATRAS.map((n,i)=>`
    <div class="nakshatra-cell ${selectedNak===i?'selected':''}" onclick="selectNakshatra(${i})">
      <div class="n-num">${String(i+1).padStart(2,'0')}</div>
      <div class="n-name">${n.name}</div>
      <div class="n-ml">${n.ml}</div>
    </div>`).join('');
}

function toggleNakshatraGrid(){document.getElementById('nakshatraGrid').classList.toggle('open');document.getElementById('selChevron').classList.toggle('open')}

function selectNakshatra(idx){
  selectedNak=idx;localStorage.setItem('selectedNak',idx);
  toggleNakshatraGrid();renderNakshatraGrid();updateSelector(idx);renderEvents();
}

function updateSelector(idx){
  const n=NAKSHATRAS[idx];
  document.getElementById('selIcon').textContent=n.symbol;
  document.getElementById('selName').textContent=n.name;
  document.getElementById('selDetail').textContent=`${n.ml} ¬∑ Lord: ${n.lord}`;
}

// FINDER
function populateFinderSelects(){
  const mSel=document.getElementById('finderMonth'),nSel=document.getElementById('finderNak');
  const curMl=getMalayalamDate(new Date());
  ML_MONTHS.forEach((m,i)=>{
    const o=document.createElement('option');
    o.value=i;o.textContent=`${m} (${ML_MONTHS_ML[i]})`;
    if(i===curMl.monthIdx)o.selected=true;
    mSel.appendChild(o);
  });
  NAKSHATRAS.forEach((n,i)=>{
    const o=document.createElement('option');
    o.value=i;o.textContent=`${n.name} ¬∑ ${n.ml}`;
    if(i===Math.max(0,selectedNak))o.selected=true;
    nSel.appendChild(o);
  });
}

function findDate(){
  const targetMonth=parseInt(document.getElementById('finderMonth').value);
  const targetNak=parseInt(document.getElementById('finderNak').value);
  const resEl=document.getElementById('finderResult'),noResEl=document.getElementById('finderNoResult');
  resEl.classList.remove('visible');noResEl.classList.remove('visible');
  finderFoundDate=null;finderFoundName=null;

  const today=new Date();today.setHours(6,0,0,0);
  const MONTHS_EN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

  for(let d=0;d<=400;d++){
    const date=new Date(today);date.setDate(today.getDate()+d);
    const ml=getMalayalamDate(date),nak=getNakshatra(date);
    if(ml.monthIdx===targetMonth&&nak===targetNak){
      const n=NAKSHATRAS[targetNak];
      document.getElementById('finderResultDate').textContent=`${date.getDate()} ${MONTHS_EN[date.getMonth()]} ${date.getFullYear()}`;
      document.getElementById('finderResultSub').textContent=`${DAYS[date.getDay()]} ¬∑ ${ml.day} ${ML_MONTHS[targetMonth]} KE ${ml.year}`;
      document.getElementById('finderResultNak').textContent=`${n.name} (${n.ml}) falls on this day`;
      const remId=`finder_${date.toDateString().replace(/ /g,'_')}_${n.name.replace(/ /g,'_')}`;
      const isSet=reminders.some(r=>r.id===remId);
      const btn=document.getElementById('finderRemindBtn');
      btn.className='finder-remind-btn'+(isSet?' set':'');
      btn.textContent=isSet?'‚úÖ Reminder Already Set':'üîî Set Reminder for this date';
      finderFoundDate=date;
      finderFoundName=`${n.name} in ${ML_MONTHS[targetMonth]}`;
      resEl.classList.add('visible');
      return;
    }
  }
  noResEl.classList.add('visible');
}

function setFinderReminder(){
  if(!finderFoundDate)return;
  const date=finderFoundDate,name=finderFoundName;
  const remId=`finder_${date.toDateString().replace(/ /g,'_')}_${name.replace(/ /g,'_')}`;
  const existing=reminders.findIndex(r=>r.id===remId);
  if(existing>=0){
    reminders.splice(existing,1);showToast('üîï Reminder removed');
  }else{
    const t=new Date(date);t.setHours(7,0,0,0);
    reminders.push({id:remId,title:`üåô ${name} Today`,body:'Your Kerala Panchang reminder',time:t.getTime(),shown:false,name,date:date.toDateString()});
    showToast('üîî Reminder set for 7:00 AM!');
    scheduleNotification(reminders[reminders.length-1]);
  }
  localStorage.setItem('reminders',JSON.stringify(reminders));
  renderReminders();findDate();
}

// EVENTS
function renderEvents(){
  if(selectedNak<0)return;
  const list=document.getElementById('eventsList');
  const events=getUpcomingEvents(selectedNak,90);
  if(!events.length){list.innerHTML=`<div class="empty-state"><div class="empty-icon">üåô</div>No events found in next 90 days.</div>`;return;}
  list.innerHTML=events.map(ev=>eventCardHTML(ev)).join('');
}

function getUpcomingEvents(nakIdx,days){
  const events=[],today=new Date();today.setHours(0,0,0,0);const seen=new Set();
  for(let d=1;d<=days;d++){
    const date=new Date(today);date.setDate(today.getDate()+d);
    const nak=getNakshatra(date),ml=getMalayalamDate(date),tithi=getTithi(date);
    const key=(t,n)=>date.toDateString()+t+n;
    if(nak===nakIdx){const k=key('j','');if(!seen.has(k)){seen.add(k);events.push({type:'janma',name:`${NAKSHATRAS[nakIdx].name} Day`,desc:`Your birth star ¬∑ ${NAKSHATRAS[nakIdx].ml}`,date,daysAway:d});}}
    FESTIVALS.forEach(f=>{if(f.nakIdx===nak&&f.monthIdx===ml.monthIdx){const k=key('f',f.name);if(!seen.has(k)){seen.add(k);events.push({type:'festival',name:f.name,desc:f.desc,date,daysAway:d});}}});
    if(tithi===10){const k=key('e','');if(!seen.has(k)){seen.add(k);events.push({type:'monthly',name:'Ekadashi',desc:`${getPaksha(date)} paksha fasting day`,date,daysAway:d});}}
    if(tithi===29){const k=key('v','');if(!seen.has(k)){seen.add(k);events.push({type:'vavu',name:'Amavasya (Vavu)',desc:'New Moon ¬∑ Pitru Tarpanam',date,daysAway:d});}}
    if(events.length>=8)break;
  }
  return events.sort((a,b)=>a.date-b.date).slice(0,8);
}

function eventCardHTML(ev){
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const id=`ev_${ev.date.toDateString().replace(/ /g,'_')}_${ev.name.replace(/ /g,'_')}`;
  const isSet=reminders.some(r=>r.id===id);
  const cd=ev.daysAway===1?'Tomorrow':`In ${ev.daysAway} days`;
  return `<div class="event-card type-${ev.type}">
    <div class="event-date-block"><div class="event-day-num">${ev.date.getDate()}</div><div class="event-month-abbr">${months[ev.date.getMonth()]}</div></div>
    <div class="event-divider"></div>
    <div class="event-info"><div class="event-name">${ev.name}</div><div class="event-desc">${ev.desc}</div><div class="event-countdown">üïê ${cd}</div></div>
    <button class="reminder-btn ${isSet?'set':''}" onclick="toggleReminder('${id}','${ev.name.replace(/'/g,"\\'")}',${ev.date.getTime()})">${isSet?'üîî':'üîï'}</button>
  </div>`;
}

function toggleReminder(id,name,timestamp){
  const ex=reminders.findIndex(r=>r.id===id);
  if(ex>=0){reminders.splice(ex,1);showToast('üîï Reminder removed');}
  else{const t=new Date(timestamp);t.setHours(7,0,0,0);reminders.push({id,title:`üåô ${name} Today`,body:'Your Kerala Panchang reminder',time:t.getTime(),shown:false,name,date:new Date(timestamp).toDateString()});showToast('üîî Reminder set for 7:00 AM');scheduleNotification(reminders[reminders.length-1]);}
  localStorage.setItem('reminders',JSON.stringify(reminders));renderEvents();renderReminders();
}

function scheduleNotification(r){if(Notification.permission!=='granted')return;const delay=r.time-Date.now();if(delay<=0)return;setTimeout(()=>new Notification(r.title,{body:r.body}),Math.min(delay,2147483647));}

function renderReminders(){
  const el=document.getElementById('remindersList');
  if(!reminders.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">üîï</div>No reminders yet.<br>Tap üîï on any event or use the date finder above.</div>`;return;}
  el.innerHTML=[...reminders].sort((a,b)=>a.time-b.time).map(r=>`
    <div class="reminder-item">
      <div class="reminder-dot"></div>
      <div class="reminder-item-info"><div class="reminder-item-name">${r.name}</div><div class="reminder-item-date">üìÖ ${r.date} at 7:00 AM</div></div>
      <button class="reminder-item-del" onclick="deleteReminder('${r.id}')">‚úï</button>
    </div>`).join('');
}

function deleteReminder(id){reminders=reminders.filter(r=>r.id!==id);localStorage.setItem('reminders',JSON.stringify(reminders));renderReminders();renderEvents();showToast('Reminder deleted');}

function renderCalendar(){
  const today=new Date(),t=new Date(today.getFullYear(),today.getMonth()+calOffset,1);
  const year=t.getFullYear(),month=t.getMonth();
  const MNAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent=`${MNAMES[month]} ${year}`;
  const mlD=getMalayalamDate(new Date(year,month,15));
  document.getElementById('calMonthMl').textContent=`${mlD.monthMl} ‚Äî KE ${mlD.year}`;
  const dim=new Date(year,month+1,0).getDate(),fdow=new Date(year,month,1).getDay();
  let html=['Su','Mo','Tu','We','Th','Fr','Sa'].map(d=>`<div class="cal-dow">${d}</div>`).join('');
  for(let i=0;i<fdow;i++)html+=`<div class="cal-cell empty"></div>`;
  for(let d=1;d<=dim;d++){
    const date=new Date(year,month,d),isToday=date.toDateString()===today.toDateString();
    const nak=getNakshatra(date),ml=getMalayalamDate(date);
    const isUserNak=nak===selectedNak;
    const isFest=FESTIVALS.some(f=>f.nakIdx===nak&&f.monthIdx===ml.monthIdx);
    const cls=['cal-cell',isToday?'today':'',isUserNak?'nakshatra-day':'',isFest?'festival-day':''].filter(Boolean).join(' ');
    html+=`<div class="${cls}" title="${NAKSHATRAS[nak].name}" onclick="openDayModal(${date.getTime()})"><span class="cal-cell-num">${d}</span><span class="cal-cell-ml">${ml.day}</span></div>`;
  }
  document.getElementById('calGrid').innerHTML=html;
}

function changeCalMonth(delta){calOffset+=delta;renderCalendar();}

function checkNotifPerm(){if(!('Notification' in window))return;if(Notification.permission==='default')document.getElementById('permBanner').classList.remove('hidden');}
function requestNotifPerm(){Notification.requestPermission().then(p=>{document.getElementById('permBanner').classList.add('hidden');if(p==='granted'){showToast('‚úÖ Notifications enabled!');reminders.forEach(r=>scheduleNotification(r));}else showToast('Notifications blocked');});}

function switchView(name,btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');btn.classList.add('active');
  if(name==='calendar')renderCalendar();
  if(name==='reminders')renderReminders();
  if(name==='recurring'){renderRecurRules();}
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAY DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TITHI_ML=['‡¥™‡µç‡¥∞‡¥§‡¥ø‡¥™‡¥¶','‡¥¶‡µç‡¥µ‡¥ø‡¥§‡µÄ‡¥Ø','‡¥§‡µÉ‡¥§‡µÄ‡¥Ø','‡¥ö‡¥§‡µÅ‡µº‡¥•‡¥ø','‡¥™‡¥û‡µç‡¥ö‡¥Æ‡¥ø','‡¥∑‡¥∑‡µç‡¥†‡¥ø','‡¥∏‡¥™‡µç‡¥§‡¥Æ‡¥ø','‡¥Ö‡¥∑‡µç‡¥ü‡¥Æ‡¥ø','‡¥®‡¥µ‡¥Æ‡¥ø','‡¥¶‡¥∂‡¥Æ‡¥ø','‡¥è‡¥ï‡¥æ‡¥¶‡¥∂‡¥ø','‡¥¶‡µç‡¥µ‡¥æ‡¥¶‡¥∂‡¥ø','‡¥§‡µç‡¥∞‡¥Ø‡µã‡¥¶‡¥∂‡¥ø','‡¥ö‡¥§‡µÅ‡µº‡¥¶‡¥∂‡¥ø','‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥ø‡¥Æ','‡¥™‡µç‡¥∞‡¥§‡¥ø‡¥™‡¥¶','‡¥¶‡µç‡¥µ‡¥ø‡¥§‡µÄ‡¥Ø','‡¥§‡µÉ‡¥§‡µÄ‡¥Ø','‡¥ö‡¥§‡µÅ‡µº‡¥•‡¥ø','‡¥™‡¥û‡µç‡¥ö‡¥Æ‡¥ø','‡¥∑‡¥∑‡µç‡¥†‡¥ø','‡¥∏‡¥™‡µç‡¥§‡¥Æ‡¥ø','‡¥Ö‡¥∑‡µç‡¥ü‡¥Æ‡¥ø','‡¥®‡¥µ‡¥Æ‡¥ø','‡¥¶‡¥∂‡¥Æ‡¥ø','‡¥è‡¥ï‡¥æ‡¥¶‡¥∂‡¥ø','‡¥¶‡µç‡¥µ‡¥æ‡¥¶‡¥∂‡¥ø','‡¥§‡µç‡¥∞‡¥Ø‡µã‡¥¶‡¥∂‡¥ø','‡¥ö‡¥§‡µÅ‡µº‡¥¶‡¥∂‡¥ø','‡¥Ö‡¥Æ‡¥æ‡¥µ‡¥æ‡¥∏‡µç‡¥Ø'];
const TITHI_EN=['Prathama','Dwitiya','Tritiya','Chaturthi','Panchami','Shashti','Saptami','Ashtami','Navami','Dashami','Ekadashi','Dwadashi','Trayodashi','Chaturdashi','Purnima','Prathama','Dwitiya','Tritiya','Chaturthi','Panchami','Shashti','Saptami','Ashtami','Navami','Dashami','Ekadashi','Dwadashi','Trayodashi','Chaturdashi','Amavasya'];
const YOGA_ML=['‡¥µ‡¥ø‡¥∑‡µç‡¥ï‡¥Ç‡¥≠','‡¥™‡µç‡¥∞‡µÄ‡¥§‡¥ø','‡¥Ü‡¥Ø‡µÅ‡¥∑‡µç‡¥Æ‡¥æ‡µª','‡¥∏‡µó‡¥≠‡¥æ‡¥ó‡µç‡¥Ø','‡¥∂‡µã‡¥≠‡¥®','‡¥Ö‡¥§‡¥ø‡¥ó‡¥£‡µç‡¥°','‡¥∏‡µÅ‡¥ï‡µº‡¥Æ','‡¥ß‡µÉ‡¥§‡¥ø','‡¥∂‡µÇ‡¥≤','‡¥ó‡¥£‡µç‡¥°','‡¥µ‡µÉ‡¥¶‡µç‡¥ß‡¥ø','‡¥ß‡µç‡¥∞‡µÅ‡¥µ','‡¥µ‡µç‡¥Ø‡¥æ‡¥ò‡¥æ‡¥§','‡¥π‡µº‡¥∑‡¥£','‡¥µ‡¥ú‡µç‡¥∞','‡¥∏‡¥ø‡¥¶‡µç‡¥ß‡¥ø','‡¥µ‡µç‡¥Ø‡¥§‡µÄ‡¥™‡¥æ‡¥§','‡¥µ‡¥∞‡µÄ‡¥Ø','‡¥™‡¥∞‡¥ø‡¥ò','‡¥∂‡¥ø‡¥µ','‡¥∏‡¥ø‡¥¶‡µç‡¥ß','‡¥∏‡¥æ‡¥¶‡µç‡¥ß‡µç‡¥Ø','‡¥∂‡µÅ‡¥≠','‡¥∂‡µÅ‡¥ï‡µç‡¥≤','‡¥¨‡µç‡¥∞‡¥π‡µç‡¥Æ','‡¥á‡¥®‡µç‡¥¶‡µç‡¥∞','‡¥µ‡µà‡¥ß‡µÉ‡¥§‡¥ø'];
const DAY_EN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const DAY_ML=['‡¥û‡¥æ‡¥Ø‡µº','‡¥§‡¥ø‡¥ô‡µç‡¥ï‡µæ','‡¥ö‡µä‡¥µ‡µç‡¥µ','‡¥¨‡µÅ‡¥ß‡µª','‡¥µ‡µç‡¥Ø‡¥æ‡¥¥‡¥Ç','‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥ø','‡¥∂‡¥®‡¥ø'];
const MON_EN=['January','February','March','April','May','June','July','August','September','October','November','December'];

let modalDate = null;
let modalSelected = {}; // {nak:bool, tithi:bool, yoga:bool, paksha:bool}
let modalNotifType = 'once'; // 'once' | 'recur'
let modalDayOffset = 0;  // 0 = day of, -1 = day before
let recurDayOffset = 0;  // same for recurring builder

function openDayModal(ts) {
  const date = new Date(ts);
  modalDate = date;
  modalSelected = {};
  modalNotifType = 'once';
  modalDayOffset = 0;

  // Reset UI
  ['nak','tithi','yoga','paksha'].forEach(k => {
    document.getElementById('md'+k.charAt(0).toUpperCase()+k.slice(1)).classList.remove('selected');
  });
  setModalNotifType('once');
  setModalOffset(0);
  updateModalSelection();

  // Calculate everything
  const nak    = getNakshatra(date);
  const tithi  = getTithi(date);
  const yoga   = getYoga(date);
  const paksha = getPaksha(date);
  const ml     = getMalayalamDate(date);
  const dow    = date.getDay();

  // Header
  document.getElementById('modalDayName').textContent =
    `${DAY_EN[dow]} ¬∑ ${DAY_ML[dow]}`;
  document.getElementById('modalGregDate').textContent =
    `${date.getDate()} ${MON_EN[date.getMonth()]} ${date.getFullYear()}`;
  document.getElementById('modalMlDate').textContent =
    `${ml.day} ${ml.monthMl} ${ml.month} ¬∑ KE ${ml.year}`;

  // Nakshatra
  const n = NAKSHATRAS[nak];
  document.getElementById('mdNakEn').textContent  = n.name;
  document.getElementById('mdNakMl').textContent  = n.ml;
  document.getElementById('mdNakSub').textContent = `Lord: ${n.lord} ¬∑ #${nak+1}`;

  // Tithi
  const ti = Math.min(tithi, 29);
  document.getElementById('mdTithiEn').textContent  = TITHI_EN[ti];
  document.getElementById('mdTithiMl').textContent  = TITHI_ML[ti];
  document.getElementById('mdTithiSub').textContent = `${paksha} Paksha ¬∑ Day ${(tithi%15)+1}`;

  // Yoga
  const yi = yoga % 27;
  document.getElementById('mdYogaEn').textContent  = YOGAS[yi];
  document.getElementById('mdYogaMl').textContent  = YOGA_ML[yi];
  document.getElementById('mdYogaSub').textContent = `Yoga #${yi+1} of 27`;

  // Paksha
  const isPurnima = tithi === 14;
  const isAmavasya = tithi === 29;
  document.getElementById('mdPakshaEn').textContent  = paksha + (isPurnima?' ‚Äî Purnima':isAmavasya?' ‚Äî Amavasya':'');
  document.getElementById('mdPakshaMl').textContent  = paksha==='Shukla'?'‡¥∂‡µÅ‡¥ï‡µç‡¥≤‡¥™‡¥ï‡µç‡¥∑‡¥Ç':'‡¥ï‡µÉ‡¥∑‡µç‡¥£‡¥™‡¥ï‡µç‡¥∑‡¥Ç';
  document.getElementById('mdPakshaSub').textContent = paksha==='Shukla'?'Waxing Moon ¬∑ Bright Half':'Waning Moon ¬∑ Dark Half';

  // Festivals
  const fests = FESTIVALS.filter(f => f.nakIdx===nak && f.monthIdx===ml.monthIdx);
  const festSec = document.getElementById('modalFestSection');
  if (fests.length) {
    festSec.style.display = 'block';
    document.getElementById('modalFestList').innerHTML = fests.map(f => `
      <div class="modal-festival-tag">
        <span style="font-size:20px">üéä</span>
        <div>
          <div>${f.name} ¬∑ <span class="modal-festival-ml">${f.ml}</span></div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px">${f.desc}</div>
        </div>
      </div>`).join('');
  } else {
    festSec.style.display = 'none';
  }

  // Open modal
  document.getElementById('dayModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeDayModal(e) {
  if (e.target === document.getElementById('dayModal')) closeDayModalDirect();
}
function closeDayModalDirect() {
  document.getElementById('dayModal').classList.remove('open');
  document.body.style.overflow = '';
}

function toggleModalCard(key) {
  modalSelected[key] = !modalSelected[key];
  const idMap = {nak:'mdNak', tithi:'mdTithi', yoga:'mdYoga', paksha:'mdPaksha'};
  document.getElementById(idMap[key]).classList.toggle('selected', !!modalSelected[key]);
  updateModalSelection();
}

function updateModalSelection() {
  const keys = Object.keys(modalSelected).filter(k => modalSelected[k]);
  const el = document.getElementById('modalSelection');
  if (!keys.length) {
    el.innerHTML = 'Nothing selected yet ‚Äî tap a detail card above';
    return;
  }
  const labels = {
    nak:    () => `<span>${document.getElementById('mdNakEn').textContent}</span> (Nakshatra)`,
    tithi:  () => `<span>${document.getElementById('mdTithiEn').textContent}</span> (Tithi)`,
    yoga:   () => `<span>${document.getElementById('mdYogaEn').textContent}</span> (Yoga)`,
    paksha: () => `<span>${document.getElementById('mdPakshaEn').textContent.split(' ‚Äî')[0]}</span> (Paksha)`,
  };
  el.innerHTML = 'Notify when: ' + keys.map(k => labels[k]()).join(' + ');
}

function setModalOffset(offset) {
  modalDayOffset = offset;
  document.getElementById('moDayOf').classList.toggle('active',  offset === 0);
  document.getElementById('moDayBef').classList.toggle('active', offset === -1);
}
function setRecurOffset(offset) {
  recurDayOffset = offset;
  document.getElementById('roDayOf').classList.toggle('active',  offset === 0);
  document.getElementById('roDayBef').classList.toggle('active', offset === -1);
}
function setModalNotifType(type) {
  modalNotifType = type;
  document.getElementById('mntOnce').classList.toggle('active', type==='once');
  document.getElementById('mntRecur').classList.toggle('active', type==='recur');
  document.getElementById('modalSaveBtn').textContent =
    type === 'once' ? 'üíæ Save One-Time Reminder' : 'üîÅ Save Recurring Reminder';
}

function saveModalReminder() {
  const keys = Object.keys(modalSelected).filter(k => modalSelected[k]);
  if (!keys.length) { showToast('‚ö†Ô∏è Tap a detail to select what to track'); return; }
  if (!modalDate)   { showToast('‚ö†Ô∏è No date selected'); return; }

  const timeVal  = document.getElementById('modalTime').value || '07:00';
  const [h, m]   = timeVal.split(':').map(Number);

  const nak   = getNakshatra(modalDate);
  const tithi = getTithi(modalDate);
  const yoga  = getYoga(modalDate) % 27;
  const ti    = Math.min(tithi, 29);

  const labelParts = {
    nak:    NAKSHATRAS[nak].name,
    tithi:  TITHI_EN[ti],
    yoga:   YOGAS[yoga],
    paksha: getPaksha(modalDate),
  };
  const label = keys.map(k => labelParts[k]).join(' + ');

  if (modalNotifType === 'once') {
    // One-time reminder on this specific date
    const fireTime = new Date(modalDate);
    fireTime.setDate(fireTime.getDate() + modalDayOffset);
    fireTime.setHours(h, m, 0, 0);
    const id = `cal_${modalDate.toDateString().replace(/ /g,'_')}_${label.replace(/ /g,'_')}`;
    if (!reminders.some(r => r.id === id)) {
      reminders.push({
        id, name: label, title: `üåô ${label} Today`,
        body: `Your Kerala Panchang reminder for ${label}`,
        time: fireTime.getTime(), shown: false,
        date: modalDate.toDateString()
      });
      localStorage.setItem('reminders', JSON.stringify(reminders));
      scheduleNotification(reminders[reminders.length-1]);
      showToast(`üîî Reminder set for ${modalDate.toDateString()}`);
    } else {
      showToast('Reminder already exists for this date');
    }

  } else {
    // Recurring rule ‚Äî build from selected criteria
    const rule = {
      id: `recur_cal_${Date.now()}`,
      label,
      trackTithi:  keys.includes('tithi'),
      trackNak:    keys.includes('nak'),
      trackYoga:   keys.includes('yoga'),
      trackPaksha: keys.includes('paksha'),
      tithiIdx:    ti,
      nakIdx:      nak,
      yogaIdx:     yoga,
      paksha:      getPaksha(modalDate),
      matchMode:   keys.length > 1 ? 'either' : 'either',
      notifyHour:  h,
      notifyMin:   m,
      dayOffset:   recurDayOffset,
    };
    recurRules.push(rule);
    localStorage.setItem('recurRules', JSON.stringify(recurRules));
    scheduleRecurringReminders();
    showToast(`üîÅ Recurring reminder saved for ${label}`);
  }

  closeDayModalDirect();
  renderReminders();
  renderRecurRules();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECURRING REMINDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TITHIS_NAMED = [
  'Prathama (1)','Dwitiya (2)','Tritiya (3)','Chaturthi (4)','Panchami (5)',
  'Shashti (6)','Saptami (7)','Ashtami (8)','Navami (9)','Dashami (10)',
  'Ekadashi (11)','Dwadashi (12)','Trayodashi (13)','Chaturdashi (14)',
  'Purnima ‚Äî Shukla (15)','Prathama (16)','Dwitiya (17)','Tritiya (18)',
  'Chaturthi (19)','Panchami (20)','Shashti (21)','Saptami (22)','Ashtami (23)',
  'Navami (24)','Dashami (25)','Ekadashi (26)','Dwadashi (27)','Trayodashi (28)',
  'Chaturdashi (29)','Amavasya (30)'
];

let recurRules = JSON.parse(localStorage.getItem('recurRules')||'[]');
// State for the builder
let rTrackTithi = true, rTrackNak = true, rMatchMode = 'either';

function initRecurring() {
  // Populate Tithi select
  const tSel = document.getElementById('recurTithiSel');
  TITHIS_NAMED.forEach((t,i) => {
    const o = document.createElement('option');
    o.value = i; o.textContent = t; tSel.appendChild(o);
  });
  // Populate Nakshatra select
  const nSel = document.getElementById('recurNakSel');
  NAKSHATRAS.forEach((n,i) => {
    const o = document.createElement('option');
    o.value = i; o.textContent = `${n.name} ¬∑ ${n.ml}`;
    if (i === Math.max(0, selectedNak)) o.selected = true;
    nSel.appendChild(o);
  });
  renderRecurRules();
  scheduleRecurringReminders();
}

function toggleRecurType(type) {
  if (type === 'tithi') {
    rTrackTithi = !rTrackTithi;
    // At least one must be active
    if (!rTrackTithi && !rTrackNak) rTrackNak = true;
  } else {
    rTrackNak = !rTrackNak;
    if (!rTrackTithi && !rTrackNak) rTrackTithi = true;
  }
  document.getElementById('rtTithi').classList.toggle('active', rTrackTithi);
  document.getElementById('rtNak').classList.toggle('active', rTrackNak);
  document.getElementById('recurTithiWrap').style.display = rTrackTithi ? 'block' : 'none';
  document.getElementById('recurNakWrap').style.display   = rTrackNak   ? 'block' : 'none';
  document.getElementById('recurMatchWrap').style.display = (rTrackTithi && rTrackNak) ? 'block' : 'none';
  document.getElementById('recurPreview').classList.remove('visible');
}

function setRecurMatch(mode) {
  rMatchMode = mode;
  document.getElementById('rmBoth').classList.toggle('active', mode === 'both');
  document.getElementById('rmEither').classList.toggle('active', mode === 'either');
}

function getRecurOccurrences(rule, daysAhead) {
  const results = [];
  const today = new Date(); today.setHours(0,0,0,0);
  for (let d = 1; d <= daysAhead; d++) {
    const date = new Date(today); date.setDate(today.getDate() + d);
    const nak   = getNakshatra(date);
    const tithi = getTithi(date);
    let match = false;
    const yoga_   = getYoga(date) % 27;
    const paksha_ = getPaksha(date);
    const checks  = [];
    if (rule.trackNak)    checks.push(nak    === rule.nakIdx);
    if (rule.trackTithi)  checks.push(tithi  === rule.tithiIdx);
    if (rule.trackYoga)   checks.push(yoga_  === rule.yogaIdx);
    if (rule.trackPaksha) checks.push(paksha_ === rule.paksha);
    if (checks.length === 0) { match = false; }
    else if (rule.matchMode === 'both') { match = checks.every(Boolean); }
    else { match = checks.some(Boolean); }
    if (match) {
      results.push({ date, daysAway: d, nak, tithi });
      if (results.length >= 8) break;
    }
  }
  return results;
}

function previewRecur() {
  const rule = buildRuleFromUI();
  const occs = getRecurOccurrences(rule, 400);
  const listEl = document.getElementById('recurPreviewList');
  const MNAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DAYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  if (!occs.length) {
    listEl.innerHTML = '<div style="color:var(--crimson);font-size:13px">No occurrences found in next 13 months.</div>';
  } else {
    listEl.innerHTML = occs.map(o => {
      const ml = getMalayalamDate(o.date);
      return `<div class="recur-occ">
        <div class="recur-occ-date">${DAYS[o.date.getDay()]} ${o.date.getDate()} ${MNAMES[o.date.getMonth()]}</div>
        <div>
          <div class="recur-occ-detail">${NAKSHATRAS[o.nak].name} ¬∑ ${TITHIS_NAMED[Math.min(o.tithi,29)]}</div>
          <div class="recur-occ-ml">${ml.day} ${ml.monthMl} KE ${ml.year} ¬∑ In ${o.daysAway} days</div>
        </div>
      </div>`;
    }).join('');
  }
  document.getElementById('recurPreview').classList.add('visible');
}

function buildRuleFromUI() {
  const tithiIdx = parseInt(document.getElementById('recurTithiSel').value);
  const nakIdx   = parseInt(document.getElementById('recurNakSel').value);
  const timeVal  = document.getElementById('recurTime').value || '07:00';
  const [h,m]    = timeVal.split(':').map(Number);
  const nakName  = NAKSHATRAS[nakIdx].name;
  const tName    = TITHIS_NAMED[tithiIdx];
  let label = '';
  if (rTrackTithi && rTrackNak) {
    label = rMatchMode === 'both'
      ? `${tName} + ${nakName}`
      : `${tName} or ${nakName}`;
  } else if (rTrackTithi) { label = tName; }
  else { label = nakName; }

  return {
    id: `recur_${Date.now()}`,
    label,
    trackTithi: rTrackTithi,
    trackNak:   rTrackNak,
    tithiIdx,
    nakIdx,
    matchMode: rMatchMode,
    notifyHour: h,
    notifyMin:  m,
  };
}

function addRecurRule() {
  const rule = buildRuleFromUI();
  recurRules.push(rule);
  localStorage.setItem('recurRules', JSON.stringify(recurRules));
  scheduleRecurringReminders();
  renderRecurRules();
  showToast(`üîÅ Recurring reminder saved!`);
  document.getElementById('recurPreview').classList.remove('visible');
}

function deleteRecurRule(id) {
  recurRules = recurRules.filter(r => r.id !== id);
  localStorage.setItem('recurRules', JSON.stringify(recurRules));
  renderRecurRules();
  showToast('Recurring reminder deleted');
}

function renderRecurRules() {
  const el = document.getElementById('recurRulesList');
  if (!recurRules.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üîÅ</div>No recurring reminders yet.<br>Use the builder above to create one.</div>';
    return;
  }
  const MNAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = new Date(); today.setHours(0,0,0,0);
  el.innerHTML = recurRules.map(rule => {
    const occs = getRecurOccurrences(rule, 400).slice(0,3);
    const icon = rule.trackTithi && rule.trackNak ? 'üîÅ' : rule.trackTithi ? 'üåí' : '‚≠ê';
    const matchDesc = rule.trackTithi && rule.trackNak
      ? `Match: ${rule.matchMode === 'both' ? 'Both must match' : 'Either matches'}`
      : '';
    const timeStr = `${String(rule.notifyHour).padStart(2,'0')}:${String(rule.notifyMin).padStart(2,'0')}`;
    const occsHtml = occs.map(o => `
      <div class="recur-rule-occ-row">
        <span class="recur-rule-occ-date">${o.date.getDate()} ${MNAMES[o.date.getMonth()]} ${o.date.getFullYear()}</span>
        <span class="recur-rule-occ-cd">In ${o.daysAway} day${o.daysAway===1?'':'s'}</span>
      </div>`).join('');
    return `
      <div class="recur-rule-card">
        <div class="recur-rule-header">
          <span class="recur-rule-icon">${icon}</span>
          <div class="recur-rule-info">
            <div class="recur-rule-name">${rule.label}</div>
            <div class="recur-rule-detail">${matchDesc ? matchDesc + ' ¬∑ ' : ''}${rule.dayOffset===-1?'üåÖ Day before ¬∑ ':'üìÖ Day of ¬∑ '}${timeStr}</div>
            ${occs[0] ? `<div class="recur-rule-next">Next: ${occs[0].date.getDate()} ${MNAMES[occs[0].date.getMonth()]} (in ${occs[0].daysAway} days)</div>` : ''}
          </div>
          <button class="recur-rule-del" onclick="deleteRecurRule('${rule.id}')">‚úï</button>
        </div>
        ${occsHtml ? `<div class="recur-rule-upcoming">${occsHtml}</div>` : ''}
      </div>`;
  }).join('');
}

// Called on every app open ‚Äî schedules one-time notifications for
// all recurring rule occurrences in the next 60 days
function scheduleRecurringReminders() {
  if (Notification.permission !== 'granted') return;
  recurRules.forEach(rule => {
    const occs = getRecurOccurrences(rule, 60);
    occs.forEach(o => {
      const fireTime = new Date(o.date);
      fireTime.setDate(fireTime.getDate() + (rule.dayOffset || 0));
      fireTime.setHours(rule.notifyHour, rule.notifyMin, 0, 0);
      const delay = fireTime.getTime() - Date.now();
      if (delay > 0 && delay < 2147483647) {
        setTimeout(() => {
          new Notification(`üîÅ ${rule.label}`, {
            body: `Today is ${NAKSHATRAS[o.nak].name} ¬∑ ${TITHIS_NAMED[Math.min(o.tithi,29)]}`,
            icon: '/Drik-panchang/icon.svg',
            tag: `recur_${rule.id}_${o.date.toDateString()}`
          });
        }, delay);
      }
    });
  });
}

if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
</script>
</body>
</html>
